<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sideline Pro | Elite Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --panel-color: #161b22;
            --border-color: #30363d;
            --primary-color: #238636; /* GitHub-style Green */
            --primary-hover: #2ea043;
            --text-main: #c9d1d9;
            --text-muted: #8b949e;
            --danger-color: #da3633;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #010409; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 15px; z-index: 10; }
        .brand { font-family: 'JetBrains Mono', monospace; color: var(--primary-color); font-size: 1.1rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        
        .btn-main { background: var(--primary-color); color: white; border: none; padding: 10px; border-radius: 6px; font-weight: 600; cursor: pointer; width: 100%; font-size: 0.9rem; transition: background 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-main:hover { background: var(--primary-hover); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); margin-top: 10px; }
        .btn-outline:hover { border-color: var(--text-muted); }

        .session-list { flex: 1; overflow-y: auto; margin-top: 20px; }
        .session-item { padding: 10px; border-radius: 6px; cursor: pointer; color: var(--text-muted); font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; transition: all 0.2s; }
        .session-item:hover { background: var(--panel-color); color: var(--text-main); }
        .session-item.active { background: rgba(35, 134, 54, 0.15); color: var(--primary-color); border-left: 3px solid var(--primary-color); }
        .edit-icon { opacity: 0; font-size: 0.8rem; }
        .session-item:hover .edit-icon { opacity: 1; }

        .credits-box { margin-top: auto; padding: 15px; background: var(--panel-color); border-radius: 8px; border: 1px solid var(--border-color); text-align: center; }
        .credit-count { font-size: 1.2rem; font-weight: 700; color: white; display: block; margin-bottom: 5px; }
        .buy-link { color: var(--primary-color); font-size: 0.8rem; text-decoration: none; font-weight: 600; cursor: pointer; }

        /* MAIN CHAT AREA */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; }
        .top-bar { height: 60px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #0d1117; }
        .current-session { font-weight: 600; font-size: 1rem; color: white; }

        #chat-feed { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        
        .msg { padding: 15px 20px; border-radius: 8px; max-width: 80%; line-height: 1.6; font-size: 0.95rem; animation: fadeUp 0.3s ease; }
        .msg.user { align-self: flex-end; background: #1f242c; color: white; border: 1px solid var(--border-color); }
        .msg.model { align-self: flex-start; color: var(--text-main); width: 100%; max-width: 900px; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* INPUT AREA */
        .input-wrapper { padding: 20px; background: var(--bg-color); border-top: 1px solid var(--border-color); }
        .input-box { display: flex; gap: 10px; background: var(--panel-color); padding: 5px; border-radius: 8px; border: 1px solid var(--border-color); align-items: center; }
        .input-box:focus-within { border-color: var(--primary-color); }
        
        input[type="text"] { flex: 1; background: transparent; border: none; padding: 12px; color: white; font-size: 0.95rem; }
        .attach-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0 15px; font-size: 1.2rem; transition: color 0.2s; }
        .attach-btn:hover { color: white; }
        .send-btn { background: var(--primary-color); color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }

        /* PROGRESS BAR */
        .progress-bar-container { width: 100%; margin-top: 10px; display: none; }
        .progress-label { font-size: 0.8rem; color: var(--primary-color); margin-bottom: 5px; display: block; text-align: center; font-family: 'JetBrains Mono'; }
        .progress-track { width: 100%; height: 4px; background: #21262d; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary-color); width: 0%; animation: load 2s infinite ease-in-out; }
        @keyframes load { 0% { width: 0%; transform: translateX(-100%); } 50% { width: 60%; } 100% { width: 100%; transform: translateX(100%); } }

        /* RIGHT LIBRARY PANEL */
        .library-panel { width: 340px; background: #010409; border-left: 1px solid var(--border-color); display: flex; flex-direction: column; }
        .lib-header { padding: 15px 20px; font-weight: 600; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; color: var(--text-main); display: flex; justify-content: space-between; }
        
        #library-feed { flex: 1; overflow-y: auto; padding: 15px; }
        .section-title { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin: 15px 0 10px; letter-spacing: 0.5px; }
        
        .clip-card { background: var(--panel-color); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 10px; transition: transform 0.2s; }
        .clip-card:hover { border-color: var(--text-muted); transform: translateY(-2px); }
        .clip-title { font-weight: 600; font-size: 0.9rem; color: white; margin-bottom: 4px; }
        .clip-meta { font-size: 0.75rem; color: var(--text-muted); }
        
        .clip-actions { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; }
        .action-chip { background: #21262d; border: 1px solid var(--border-color); color: var(--text-main); font-size: 0.7rem; padding: 4px 8px; border-radius: 4px; cursor: pointer; text-decoration: none; text-align: center; flex: 1; }
        .action-chip:hover { background: #30363d; color: white; }
        .action-chip.delete { color: var(--danger-color); border-color: rgba(218, 54, 51, 0.3); }
        .action-chip.delete:hover { background: rgba(218, 54, 51, 0.1); }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(2px); z-index: 50; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #161b22; border: 1px solid var(--border-color); width: 600px; max-width: 90%; max-height: 85vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-weight: 600; }
        .modal-body { padding: 20px; overflow-y: auto; color: var(--text-main); line-height: 1.6; }
        .close-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.2rem; }
    </style>
</head>
<body>

<div id="auth-modal" class="modal-overlay" style="display: flex;">
    <div class="modal-content" style="width: 350px; text-align: center;">
        <div class="modal-body">
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">SIDELINE PRO</h2>
            <input type="email" id="auth-email" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 6px;">
            <input type="password" id="auth-pass" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 6px;">
            <button class="btn-main" onclick="handleAuth('login')">LOGIN</button>
            <button class="btn-outline" style="width:100%; padding:10px; margin-top:10px; border-radius:6px; cursor:pointer;" onclick="handleAuth('signup')">Create Account (3 Free Credits)</button>
        </div>
    </div>
</div>

<div id="video-modal" class="modal-overlay">
    <div class="modal-content" style="width: 800px;">
        <div class="modal-header">
            <span>Clip Review</span>
            <button class="close-btn" onclick="closeModals()">√ó</button>
        </div>
        <div class="modal-body" style="padding: 0; background: black;">
            <video id="main-player" controls style="width: 100%; display: block;"></video>
        </div>
    </div>
</div>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span>Scouting Report</span>
            <button class="close-btn" onclick="closeModals()">√ó</button>
        </div>
        <div id="report-text" class="modal-body"></div>
    </div>
</div>

<div id="clip-chat-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span>Clip War Room</span>
            <button class="close-btn" onclick="closeModals()">√ó</button>
        </div>
        <div class="modal-body" style="display: flex; flex-direction: column; height: 400px;">
            <div id="clip-chat-history" style="flex: 1; overflow-y: auto; margin-bottom: 10px; padding: 10px; background: #0d1117; border-radius: 6px;"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="clip-chat-input" placeholder="Ask about this specific play..." style="background: #0d1117; border: 1px solid #30363d; border-radius: 6px;">
                <button class="btn-main" style="width: auto;" onclick="sendClipMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<div class="app-container">
    <div class="sidebar">
        <div class="brand"><span>‚ö°</span> SIDELINE PRO</div>
        <button class="btn-main" onclick="createNewChat()">+ New Session</button>
        
        <div id="session-list" class="session-list"></div>
        
        <div class="credits-box">
            <span class="credit-count" id="credit-display">--</span>
            <span style="font-size: 0.8rem; color: #8b949e;">Credits Available</span>
            <div class="buy-link" style="margin-top: 10px;" onclick="buyCredits()">Get 50 Credits ($15)</div>
            <div style="margin-top: 15px; font-size: 0.75rem; color: #444; cursor: pointer;" onclick="logout()">LOGOUT</div>
        </div>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <span class="current-session" id="current-chat-title">Select a Session</span>
            <button class="btn-outline" style="font-size: 0.8rem; padding: 5px 10px; border-radius: 4px; cursor: pointer;" onclick="generateSessionSummary()">Create Session Report</button>
        </div>

        <div id="chat-feed">
            <div class="msg model">System Online. Ready for analysis.</div>
        </div>

        <div class="progress-bar-container" id="progress-bar">
            <span class="progress-label">ANALYZING FOOTAGE...</span>
            <div class="progress-track"><div class="progress-fill"></div></div>
        </div>

        <div class="input-wrapper">
            <div id="file-preview" style="display:none; padding-bottom: 10px; font-size: 0.85rem; color: var(--primary-color);">
                <span id="file-name"></span> 
                <span style="color: #da3633; cursor: pointer; margin-left: 10px;" onclick="removeFile()">[Remove]</span>
            </div>

            <div class="input-box">
                <input type="file" id="file-input" accept="video/*" hidden>
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="text" id="user-input" placeholder="Upload a clip or ask a question..." autocomplete="off">
                <button class="send-btn" id="send-btn">SEND</button>
            </div>
        </div>
    </div>

    <div class="library-panel">
        <div class="lib-header">
            <span>LIBRARY</span>
            <span style="font-size: 0.75rem; color: #8b949e;" id="clip-count">0 Clips</span>
        </div>
        <div id="library-feed"></div>
    </div>
</div>

<script>
    let currentUser = localStorage.getItem('sideline_user');
    let currentSessionId = null;
    let currentClipId = null;
    let libraryData = [];

    window.onload = () => {
        if (!currentUser) document.getElementById('auth-modal').style.display = 'flex';
        else { loadSessions(); loadLibrary(); refreshCredits(); }
    };

    // --- AUTH ---
    async function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const res = await fetch(`/api/${type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            currentUser = email;
            localStorage.setItem('sideline_user', email);
            document.getElementById('auth-modal').style.display = 'none';
            loadSessions(); loadLibrary(); refreshCredits();
        } else alert(data.error);
    }
    function logout() { localStorage.removeItem('sideline_user'); location.reload(); }
    async function refreshCredits() {
        const res = await fetch('/api/balance', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: currentUser }) });
        const data = await res.json();
        document.getElementById('credit-display').textContent = data.credits;
    }
    async function buyCredits() {
        const res = await fetch('/api/buy-credits', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: currentUser }) });
        const data = await res.json();
        if(data.success && data.url) window.location.href = data.url;
        else if(data.success) { alert(data.message); refreshCredits(); }
    }

    // --- CHAT & AI ---
    document.getElementById('file-input').addEventListener('change', function() {
        if(this.files[0]) {
            document.getElementById('file-preview').style.display = 'block';
            document.getElementById('file-name').textContent = "üìé " + this.files[0].name;
        }
    });
    function removeFile() {
        document.getElementById('file-input').value = '';
        document.getElementById('file-preview').style.display = 'none';
    }

    document.getElementById('send-btn').addEventListener('click', async () => {
        const text = document.getElementById('user-input').value;
        const file = document.getElementById('file-input').files[0];
        if(!text && !file) return;
        if(!currentSessionId) createNewChat();

        addMessage(text || "Analyzing footage...", 'user');
        document.getElementById('user-input').value = '';
        removeFile();

        // SHOW PROGRESS BAR
        document.getElementById('progress-bar').style.display = 'block';

        const payload = { message: text, sessionId: currentSessionId, email: currentUser };
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                payload.fileData = reader.result.split(',')[1];
                payload.mimeType = file.type;
                sendPayload(payload);
            };
        } else { sendPayload(payload); }
    });

    async function sendPayload(payload) {
        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            
            // HIDE PROGRESS BAR
            document.getElementById('progress-bar').style.display = 'none';

            if(data.error) addMessage(data.error, 'model');
            else {
                addMessage(data.reply, 'model');
                if(data.newClip) loadLibrary();
                refreshCredits();
            }
        } catch(e) { 
            document.getElementById('progress-bar').style.display = 'none';
            addMessage("Connection error", 'model'); 
        }
    }

    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `msg ${role}`;
        div.textContent = text;
        document.getElementById('chat-feed').appendChild(div);
        document.getElementById('chat-feed').scrollTop = document.getElementById('chat-feed').scrollHeight;
    }

    // --- LIBRARY ---
    async function loadLibrary() {
        const res = await fetch(`/api/search?email=${currentUser}&sessionId=${currentSessionId}`);
        libraryData = await res.json();
        document.getElementById('clip-count').textContent = `${libraryData.length} Clips`;
        
        const content = document.getElementById('library-feed');
        content.innerHTML = '';
        
        const groups = {};
        libraryData.forEach(clip => {
            const sec = clip.section || "General";
            if(!groups[sec]) groups[sec] = [];
            groups[sec].push(clip);
        });

        Object.keys(groups).forEach(section => {
            content.innerHTML += `<div class="section-title">${section}</div>`;
            groups[section].forEach(clip => {
                const div = document.createElement('div');
                div.className = 'clip-card';
                div.innerHTML = `
                    <div class="clip-title">${clip.title}</div>
                    <div class="clip-meta">${clip.formation} vs ${clip.coverage}</div>
                    <div class="clip-actions">
                        <div class="action-chip" onclick="playVideo('${clip.id}')">‚ñ∂ Watch</div>
                        <div class="action-chip" onclick="viewReport('${clip.id}')">üìÑ Report</div>
                        <div class="action-chip" onclick="openClipChat('${clip.id}')">üí¨ Ask</div>
                        <div class="action-chip" onclick="changeSection('${clip.id}')">üìÇ Move</div>
                        <div class="action-chip delete" onclick="deleteClip('${clip.id}')">‚úï</div>
                    </div>
                `;
                content.appendChild(div);
            });
        });
    }

    // --- FEATURES ---
    function playVideo(id) {
        document.getElementById('main-player').src = `/plays/${id}`;
        document.getElementById('video-modal').style.display = 'flex';
    }

    function viewReport(id) {
        const clip = libraryData.find(c => c.id === id);
        const r = clip.fullData?.scouting_report || {};
        document.getElementById('report-text').innerHTML = `
            <h3 style="color:var(--primary-color)">Summary</h3><p>${r.summary}</p><br>
            <h3 style="color:#e9b949">Action Plan</h3><p>${r.action_plan}</p><br>
            <h3 style="color:#da3633">Mistakes</h3><ul>${(r.mistakes||[]).map(m=>`<li>${m}</li>`).join('')}</ul>
        `;
        document.getElementById('report-modal').style.display = 'flex';
    }

    function openClipChat(id) {
        currentClipId = id;
        document.getElementById('clip-chat-history').innerHTML = '<div style="color:#8b949e; text-align:center; padding:20px;">Ask specific questions about this clip.</div>';
        document.getElementById('clip-chat-modal').style.display = 'flex';
    }

    async function sendClipMessage() {
        const msg = document.getElementById('clip-chat-input').value;
        if(!msg) return;
        document.getElementById('clip-chat-history').innerHTML += `<div style="text-align:right; margin:5px; color:white;">${msg}</div>`;
        document.getElementById('clip-chat-input').value = '';
        
        const clip = libraryData.find(c => c.id === currentClipId);
        const res = await fetch('/api/clip-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: msg, context: clip })
        });
        const data = await res.json();
        document.getElementById('clip-chat-history').innerHTML += `<div style="text-align:left; margin:5px; color:var(--primary-color);">${data.reply}</div>`;
    }

    async function deleteClip(id) {
        if(!confirm("Delete this clip permanently?")) return;
        await fetch('/api/delete-clip', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, owner: currentUser }) });
        loadLibrary();
    }

    async function changeSection(id) {
        const sec = prompt("Enter new folder name:");
        if(sec) {
            await fetch('/api/update-clip', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, section: sec, owner: currentUser }) });
            loadLibrary();
        }
    }

    async function generateSessionSummary() {
        if(!currentSessionId) return alert("Select a session first.");
        addMessage("Generating session report...", 'user');
        const res = await fetch('/api/session-summary', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email: currentUser, sessionId: currentSessionId }) });
        const data = await res.json();
        addMessage(data.report, 'model');
    }

    // --- SESSIONS ---
    async function loadSessions() {
        const res = await fetch(`/api/sessions?email=${currentUser}`);
        const sessions = await res.json();
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        sessions.forEach(s => {
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `<span onclick="loadChat('${s.id}', '${s.title}')" style="flex:1">${s.title}</span><span class="edit-icon" onclick="renameSession('${s.id}')">‚úèÔ∏è</span>`;
            list.appendChild(div);
        });
    }

    async function createNewChat() {
        currentSessionId = Math.random().toString(36).substr(2, 9);
        document.getElementById('current-chat-title').textContent = "New Session";
        document.getElementById('chat-feed').innerHTML = '<div class="msg model">System Online. Ready for analysis.</div>';
        document.getElementById('library-feed').innerHTML = '';
        loadSessions();
    }

    async function loadChat(id, title) {
        currentSessionId = id;
        document.getElementById('current-chat-title').textContent = title;
        loadSessions();
        const res = await fetch(`/api/session/${id}`);
        const history = await res.json();
        const feed = document.getElementById('chat-feed');
        feed.innerHTML = '';
        history.forEach(msg => addMessage(msg.text, msg.role));
        loadLibrary();
    }

    async function renameSession(id) {
        const newName = prompt("Rename Session:");
        if(newName) {
            await fetch('/api/rename-session', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ sessionId: id, newTitle: newName, email: currentUser }) });
            loadSessions();
        }
    }

    function closeModals() {
        document.querySelectorAll('.modal-overlay').forEach(el => { if(el.id !== 'auth-modal') el.style.display = 'none'; });
        document.getElementById('main-player').pause();
    }
</script>
</body>
</html>
