<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sideline Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* THEME: Dark Navy & Bright Blue */
            --bg-body: #05080f; /* Very dark navy */
            --bg-panel: #0f1623; /* Lighter navy panel */
            --bg-card: #151e2e;
            --accent: #3b82f6; /* Bright Blue */
            --accent-hover: #2563eb;
            --text-main: #ffffff;
            --text-muted: #94a3b8;
            --border: #1e293b;
            --btn-dark: #1e293b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
        
        body { 
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, var(--bg-body) 60%);
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }

        /* --- NAVBAR --- */
        .navbar {
            height: 70px;
            background: transparent;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            z-index: 50;
        }

        .nav-left { display: flex; align-items: center; gap: 30px; }
        
        .logo { 
            font-size: 1.5rem; font-weight: 800; color: white; display: flex; align-items: center; gap: 8px; 
        }
        /* The stylized S logo */
        .logo-icon { color: var(--accent); font-size: 1.8rem; }

        /* SESSIONS DROPDOWN */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-btn {
            background: transparent; border: none; color: var(--text-muted); font-size: 0.95rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .dropdown-btn:hover { color: white; }
        .dropdown-content {
            display: none; position: absolute; top: 100%; left: 0; 
            background: var(--bg-card); min-width: 220px; 
            border: 1px solid var(--border); border-radius: 8px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 100; padding: 5px;
            margin-top: 10px;
        }
        .dropdown.active .dropdown-content { display: block; }
        
        .session-option {
            padding: 10px 15px; color: var(--text-muted); font-size: 0.9rem; cursor: pointer; border-radius: 6px; transition: 0.2s;
        }
        .session-option:hover { background: var(--btn-dark); color: white; }
        .session-option.active { color: var(--accent); background: rgba(59, 130, 246, 0.1); }
        .session-divider { height: 1px; background: var(--border); margin: 5px 0; }

        /* NAV RIGHT */
        .nav-right { display: flex; gap: 15px; }
        .pill-btn {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .pill-btn:hover { border-color: var(--text-muted); color: white; background: rgba(255,255,255,0.05); }

        /* --- MAIN LAYOUT --- */
        .app-container {
            display: flex; flex: 1; height: calc(100vh - 70px); padding: 40px; gap: 40px; justify-content: center; position: relative;
        }

        /* CENTER STAGE (Video & Buttons) */
        .stage-center {
            flex: 1; max-width: 900px; display: flex; flex-direction: column; gap: 20px;
        }

        /* VIDEO PLAYER */
        .video-card {
            width: 100%; aspect-ratio: 16/9; background: black; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); position: relative; box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        video { width: 100%; height: 100%; display: block; }

        /* ACTION BAR (The 3 Buttons) */
        .action-bar {
            display: flex; gap: 15px; padding: 10px 0;
        }
        .main-btn {
            flex: 1; padding: 14px; border-radius: 8px; border: none; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        /* Specific Button Styles */
        .btn-blue { background: var(--accent); color: white; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); }
        .btn-blue:hover { background: var(--accent-hover); transform: translateY(-1px); }
        
        .btn-dark { background: var(--bg-panel); border: 1px solid var(--border); color: #cbd5e1; }
        .btn-dark:hover { background: var(--border); color: white; }

        /* RIGHT SIDEBAR (Clip Library) */
        .library-panel {
            width: 320px;
            background: rgba(15, 22, 35, 0.6); /* Semi-transparent */
            border: 1px solid var(--border);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            display: flex; flex-direction: column;
            height: fit-content; max-height: 100%;
        }
        .lib-header {
            padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: 700; color: white;
        }
        .lib-content { padding: 10px; overflow-y: auto; max-height: 600px; }
        
        /* Clip Items */
        .clip-row {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            border-radius: 6px; cursor: pointer; transition: 0.2s; color: var(--text-muted);
        }
        .clip-row:hover { background: rgba(255,255,255,0.05); color: white; }
        .play-circle {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: var(--text-muted);
        }
        .clip-row:hover .play-circle { border-color: var(--accent); color: var(--accent); }

        /* UPLOAD ZONE (Hidden visually but functional) */
        .upload-trigger { text-align: center; margin-top: 20px; color: var(--text-muted); font-size: 0.8rem; cursor: pointer; }
        .upload-trigger:hover { color: var(--accent); text-decoration: underline; }

        /* AI CHAT OVERLAY (For "Ask Questions") */
        .chat-overlay {
            position: fixed; bottom: 20px; right: 400px; width: 400px; height: 500px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px;
            display: none; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.6); z-index: 99;
        }
        .chat-header-bar { padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700; display: flex; justify-content: space-between; }
        .chat-scroll { flex: 1; overflow-y: auto; padding: 15px; font-size: 0.9rem; line-height: 1.5; color: #cbd5e1; }
        .chat-input-area { padding: 15px; border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-in { flex: 1; background: var(--bg-body); border: 1px solid var(--border); padding: 8px; color: white; border-radius: 4px; }

        /* MODALS */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-card { background: var(--bg-card); border: 1px solid var(--border); width: 400px; padding: 30px; border-radius: 12px; text-align: center; }
        .input-std { width: 100%; padding: 12px; background: var(--bg-body); border: 1px solid var(--border); color: white; border-radius: 6px; margin-bottom: 15px; }
        
        /* Report Modal Styles */
        .report-content { text-align: left; white-space: pre-wrap; color: #cbd5e1; max-height: 60vh; overflow-y: auto; line-height: 1.6; }
        
        /* Loading Bar */
        .loading-line { height: 3px; background: var(--accent); width: 0%; position: absolute; top: 0; left: 0; z-index: 100; transition: width 0.3s; }
    </style>
</head>
<body>

    <div class="loading-line" id="loader"></div>

    <div class="navbar">
        <div class="nav-left">
            <div class="logo"><span class="logo-icon">âš¡</span> SidelinePro</div>
            
            <div class="dropdown" onclick="this.classList.toggle('active')">
                <button class="dropdown-btn">
                    <span id="current-session-label">Sessions</span> 
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </button>
                <div class="dropdown-content">
                    <div class="session-option" onclick="createNewChat('player')">+ New Player Session</div>
                    <div class="session-option" onclick="createNewChat('team')">+ New Team Session</div>
                    <div class="session-divider"></div>
                    <div id="session-list-container">
                        </div>
                </div>
            </div>
        </div>

        <div class="nav-right">
            <button class="pill-btn" onclick="showReportOptions()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                Scout Report
            </button>
            <button class="pill-btn" onclick="openSettings()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                Settings
            </button>
            <button id="auth-btn" class="pill-btn" style="border-color:var(--accent); color:var(--accent);" onclick="handleNavClick()">Sign Up</button>
        </div>
    </div>

    <div class="app-container">
        
        <div class="stage-center">
            <h2 style="font-weight:700; color:white;">Analysis Clip</h2>
            
            <div class="video-card">
                <video id="main-player" controls poster="https://via.placeholder.com/1200x675/0f1623/3b82f6?text=SidelinePro+Video+Feed"></video>
            </div>

            <div class="action-bar">
                <button class="main-btn btn-blue" onclick="document.getElementById('main-player').play()">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg> Watch
                </button>
                <button class="main-btn btn-dark" onclick="openAskModal()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Ask more questions
                </button>
                <button class="main-btn btn-dark" onclick="organizeClip()">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg> Organize
                </button>
            </div>

            <input type="file" id="file-input" accept="video/*" style="display:none;" onchange="handleFileUpload()">
            <div class="upload-trigger" onclick="document.getElementById('file-input').click()">+ Upload New Clip to Session</div>
        </div>

        <div class="library-panel">
            <div class="lib-header">
                <span>Clip Library</span>
                <span style="font-size:1.2rem; cursor:pointer;">â€¢â€¢â€¢</span>
            </div>
            <div style="padding:10px;">
                <input type="text" id="lib-search" placeholder="Search..." style="width:100%; background:#05080f; border:1px solid #1e293b; padding:8px; color:white; border-radius:6px;" oninput="filterLibrary()">
            </div>
            <div id="library-feed" class="lib-content">
                </div>
        </div>

    </div>

    <div id="ask-modal" class="chat-overlay">
        <div class="chat-header-bar">
            <span>War Room</span>
            <span style="cursor:pointer;" onclick="closeAskModal()">Ã—</span>
        </div>
        <div id="chat-history" class="chat-scroll"></div>
        <div class="chat-input-area">
            <input type="text" id="ask-input" class="chat-in" placeholder="Ask about this clip...">
            <button class="pill-btn" style="background:var(--accent); border:none; color:white;" onclick="sendAsk()">Send</button>
        </div>
    </div>

    <div id="auth-modal" class="modal">
        <div class="modal-card">
            <h2 style="color:white; margin-bottom:20px;">Welcome Coach</h2>
            <input type="email" id="auth-email" class="input-std" placeholder="Email">
            <input type="password" id="auth-pass" class="input-std" placeholder="Password">
            <button class="main-btn btn-blue" onclick="handleAuth('signup')">Sign Up</button>
            <div style="margin-top:15px; color:#666; font-size:0.8rem; cursor:pointer;" onclick="handleAuth('login')">Login instead</div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-card">
            <h3>Settings</h3>
            <p id="user-email-display" style="color:#94a3b8; margin:15px 0;">--</p>
            <button class="main-btn btn-dark" onclick="closeModals()">Close</button>
            <button class="main-btn btn-dark" style="color:#ef4444; margin-top:10px;" onclick="logout()">Logout</button>
        </div>
    </div>

    <div id="report-modal" class="modal">
        <div class="modal-card" style="width:600px;">
            <h3>Scouting Report</h3>
            <div style="display:flex; gap:10px; margin:20px 0;">
                <button class="main-btn btn-blue" onclick="generateReport('offense')">Offense</button>
                <button class="main-btn btn-dark" onclick="generateReport('defense')">Defense</button>
            </div>
            <div id="report-text" class="report-content"></div>
            <button class="main-btn btn-dark" style="margin-top:20px;" onclick="closeModals()">Close</button>
        </div>
    </div>

<script>
    let authToken = localStorage.getItem('sideline_token');
    let currentUserEmail = localStorage.getItem('sideline_email');
    let currentSessionId = null;
    let currentClipId = null;
    let currentClipData = null;
    let libraryData = [];

    // --- INIT ---
    window.onload = () => {
        updateNavState();
        if(authToken) { loadSessions(); } 
        else { document.getElementById('auth-modal').style.display = 'flex'; }
    };

    // --- API HELPER ---
    async function apiFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        options.headers['Authorization'] = `Bearer ${authToken}`;
        options.headers['Content-Type'] = 'application/json';
        return fetch(url, options);
    }

    // --- SESSIONS (DROPDOWN LOGIC) ---
    async function createNewChat(type) {
        const name = prompt("Name this session:", type === 'player' ? "Player Dev" : "Game Prep");
        if(!name) return;
        
        const res = await apiFetch('/api/create-session', { method: 'POST', body: JSON.stringify({ title: name, type: type }) });
        const data = await res.json();
        
        if(data.success) {
            currentSessionId = data.sessionId;
            document.getElementById('current-session-label').innerText = name;
            loadSessions();
            loadLibrary();
        }
    }

    async function loadSessions() {
        const res = await apiFetch('/api/sessions');
        const list = await res.json();
        const container = document.getElementById('session-list-container');
        container.innerHTML = '';
        
        if(list.length > 0 && !currentSessionId) {
            // Auto load most recent
            loadChat(list[0].id, list[0].title);
        }

        list.forEach(s => {
            const icon = s.type === 'player' ? 'ðŸ‘¤' : 'ðŸ›¡ï¸';
            const div = document.createElement('div');
            div.className = `session-option ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `${icon} ${s.title}`;
            div.onclick = () => loadChat(s.id, s.title);
            container.appendChild(div);
        });
    }

    async function loadChat(id, title) {
        currentSessionId = id;
        document.getElementById('current-session-label').innerText = title;
        // Close dropdown
        document.querySelector('.dropdown').classList.remove('active');
        // Refresh Library
        loadLibrary();
        // Update list active state
        loadSessions();
    }

    // --- LIBRARY & VIDEO ---
    async function loadLibrary() {
        if(!currentSessionId) {
            document.getElementById('library-feed').innerHTML = '<div style="color:#666; padding:10px; font-size:0.8rem;">Select a session</div>';
            return;
        }
        
        const res = await apiFetch(`/api/search?sessionId=${currentSessionId}`);
        const clips = await res.json();
        libraryData = clips;
        renderLibrary(clips);
    }

    function renderLibrary(clips) {
        const feed = document.getElementById('library-feed');
        feed.innerHTML = '';
        
        clips.forEach(clip => {
            const div = document.createElement('div');
            div.className = 'clip-row';
            // Use full JSON for onclick to have data context
            const clipStr = JSON.stringify(clip).replace(/"/g, '&quot;');
            div.setAttribute('onclick', `playClip(${clipStr})`);
            
            div.innerHTML = `
                <div class="play-circle">â–¶</div>
                <div>
                    <div style="font-weight:600; font-size:0.9rem; color:white;">${clip.title}</div>
                    <div style="font-size:0.75rem; opacity:0.6;">${clip.formation}</div>
                </div>
            `;
            feed.appendChild(div);
        });
    }

    function playClip(clip) {
        const player = document.getElementById('main-player');
        player.src = `/plays/${clip.id}`;
        player.play();
        currentClipId = clip.id;
        currentClipData = clip.fullData || clip;
    }

    function filterLibrary() {
        const term = document.getElementById('lib-search').value.toLowerCase();
        const filtered = libraryData.filter(c => c.title.toLowerCase().includes(term));
        renderLibrary(filtered);
    }

    // --- UPLOAD & ANALYZE ---
    async function handleFileUpload() {
        if(!currentSessionId) return alert("Please select or create a session first.");
        
        const fileInput = document.getElementById('file-input');
        const file = fileInput.files[0];
        if(!file) return;

        // Show loading
        document.getElementById('loader').style.width = '70%';
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const payload = {
                message: `Analyze: ${file.name}`,
                sessionId: currentSessionId,
                fileData: reader.result.split(',')[1],
                mimeType: file.type
            };
            
            try {
                const res = await apiFetch('/api/chat', { method: 'POST', body: JSON.stringify(payload) });
                const data = await res.json();
                document.getElementById('loader').style.width = '0%';
                
                if(data.newClip) {
                    loadLibrary();
                    playClip(data.newClip); // Auto play
                }
            } catch(e) { alert("Analysis failed"); document.getElementById('loader').style.width = '0%'; }
        };
    }

    // --- ASK & ORGANIZE ---
    function openAskModal() {
        if(!currentClipId) return alert("Select a clip to discuss.");
        document.getElementById('ask-modal').style.display = 'flex';
        document.getElementById('chat-history').innerHTML = `<div style="color:var(--accent);">Analyzing: ${currentClipData?.title || 'Current Clip'}</div>`;
    }
    
    function closeAskModal() { document.getElementById('ask-modal').style.display = 'none'; }

    async function sendAsk() {
        const input = document.getElementById('ask-input');
        const txt = input.value;
        if(!txt) return;
        
        const hist = document.getElementById('chat-history');
        hist.innerHTML += `<div style="text-align:right; margin:10px 0; color:white;">${txt}</div>`;
        input.value = '';

        const res = await apiFetch('/api/clip-chat', { method: 'POST', body: JSON.stringify({ message: txt, context: currentClipData }) });
        const data = await res.json();
        
        // Format bold and bullets
        let reply = data.reply.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\* /g, '<br>â€¢ ');
        hist.innerHTML += `<div style="text-align:left; margin:10px 0; color:#94a3b8;">${reply}</div>`;
        hist.scrollTop = hist.scrollHeight;
    }

    async function organizeClip() {
        if(!currentClipId) return alert("No clip selected.");
        const sec = prompt("New Section Name (e.g. Redzone):");
        if(sec) {
            await apiFetch('/api/update-clip', { method: 'POST', body: JSON.stringify({ id: currentClipId, section: sec }) });
            loadLibrary();
        }
    }

    // --- SCOUT REPORT ---
    function showReportOptions() { 
        if(!currentSessionId) return alert("Select a session.");
        document.getElementById('report-modal').style.display = 'flex'; 
    }
    
    async function generateReport(focus) {
        document.getElementById('report-text').innerText = "Analyzing tendency data...";
        const res = await apiFetch('/api/session-summary', { method: 'POST', body: JSON.stringify({ sessionId: currentSessionId, focus: focus }) });
        const data = await res.json();
        document.getElementById('report-text').innerText = data.report;
    }

    // --- AUTH & MISC ---
    function handleNavClick() { 
        if(authToken) openSettings(); 
        else document.getElementById('auth-modal').style.display = 'flex'; 
    }
    
    function updateNavState() {
        const btn = document.getElementById('auth-btn');
        if(authToken) { btn.innerText = "Log Out"; btn.onclick = logout; }
    }

    async function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const pass = document.getElementById('auth-pass').value;
        const res = await fetch(`/api/${type}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ email, password: pass }) });
        const data = await res.json();
        if(data.success) {
            authToken = data.token; currentUserEmail = email;
            localStorage.setItem('sideline_token', authToken);
            localStorage.setItem('sideline_email', email);
            closeModals(); updateNavState(); loadSessions();
        } else alert(data.error);
    }

    function openSettings() {
        document.getElementById('user-email-display').innerText = currentUserEmail;
        document.getElementById('settings-modal').style.display = 'flex';
    }

    function closeModals() { document.querySelectorAll('.modal').forEach(el => el.style.display = 'none'); }
    function logout() { localStorage.clear(); location.reload(); }

</script>
</body>
</html>
