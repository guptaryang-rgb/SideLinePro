<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vantage Vision | Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <script crossorigin="anonymous" data-clerk-publishable-key="pk_test_YXNzdXJlZC1iYWJvb24tNTkuY2xlcmsuYWNjb3VudHMuZGV2JA" src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>

    <style>
        :root { --bg-deep:#09090b; --bg-panel:#18181b; --bg-card:#27272a; --border:#3f3f46; --text:#e4e4e7; --accent:#38bdf8; --danger:#ef4444; --success:#22c55e; --warning:#f59e0b; }
        body { background:var(--bg-deep); color:var(--text); font-family:'Inter',sans-serif; height:100vh; display:flex; flex-direction:column; overflow:hidden; margin:0; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-deep); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        .navbar { height:70px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; padding:0 40px; background:rgba(10,10,10,0.95); flex-shrink: 0; z-index: 10; }
        .logo { font-weight:900; font-size:1.6rem; letter-spacing:-1px; } .logo span { color:var(--accent); }
        
        .nav-tabs { display:flex; gap:30px; background:#1a1a1a; padding:5px; border-radius:30px; border:1px solid var(--border); }
        .nav-tab { padding:8px 25px; border-radius:20px; font-weight:600; font-size:0.9rem; cursor:pointer; transition:0.3s; color:#888; }
        .nav-tab.active { background:var(--accent); color:black; box-shadow:0 0 15px rgba(56,189,248,0.3); }

        .view-container { flex:1; position:relative; overflow:hidden; }
        .view { position:absolute; inset:0; display:none; flex-direction:column; }
        .view.active-view { display:flex; }
        
        /* LAYOUT ENFORCEMENT */
        .app-body { 
            flex:1; display:flex; overflow:hidden; width: 100vw; 
            justify-content: space-between; /* Pins panels to edges */
        }
        
        .sidebar, .lib-panel { 
            width:280px; background:var(--bg-panel); border-right:1px solid var(--border); 
            display:flex; flex-direction:column; transition:0.3s; flex-shrink:0; 
        }
        .lib-panel { border-right:none; border-left:1px solid var(--border); width: 320px; }
        .sidebar.collapsed { margin-left: -280px; }
        .lib-panel.collapsed { margin-right: -320px; }

        .main { flex:1; display:flex; flex-direction:column; background:radial-gradient(circle at 50% 30%, #1c1c1f 0%, #09090b 80%); min-width: 0; }
        .chat-feed { flex:1; overflow-y:auto; padding:40px; display:flex; flex-direction:column; gap:30px; scroll-behavior: smooth; }
        
        /* TOOLS BAR */
        .tools-bar { 
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; 
            padding: 12px 25px; background: var(--bg-panel); border-top: 1px solid var(--border); height: 50px; 
        }
        .tools-left { justify-self: start; }
        .tools-center { justify-self: center; display: flex; gap: 15px; }
        .tools-right { justify-self: end; }
        
        .tool-btn { background: #27272a; border: 1px solid #3f3f46; color: #ccc; font-size: 0.85rem; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; transition:0.2s; display:flex; align-items:center; gap:8px; white-space:nowrap; }
        .tool-btn:hover { border-color:var(--accent); color:white; background:#333; }

        .input-bar { padding:20px; background:var(--bg-panel); display:flex; gap:10px; align-items:center; border-top: 1px solid #27272a; }
        .input-box { flex:1; background:#000; border:1px solid var(--border); color:white; padding:12px 20px; border-radius:30px; outline:none; transition: border-color 0.2s; }
        .input-box:focus { border-color: var(--accent); }
        .pos-select { background:#27272a; color:white; border:1px solid var(--border); padding:10px; border-radius:20px; font-weight:600; cursor:pointer; }
        .btn { padding:0 25px; background:var(--accent); color:black; border:none; border-radius:30px; font-weight:800; cursor:pointer; transition: opacity 0.2s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .session-item { padding:12px 15px; margin-bottom:5px; cursor:pointer; border-radius:8px; color:#a1a1aa; font-size:0.9rem; display:flex; justify-content:space-between; align-items:center; transition:0.2s; }
        .session-item:hover { background:#3f3f46; color:white; }
        .session-item.active { background:#27272a; color:var(--accent); border-left:3px solid var(--accent); padding-left: 12px; }

        #progress-container { display:none; position:absolute; top:0; width:100%; height:3px; background:#333; z-index:100; }
        #progress-bar { height:100%; width:0%; background:var(--accent); transition:width 0.3s; box-shadow: 0 0 10px var(--accent); }

        /* CARDS */
        .scout-card { background: #18181b; border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        .scout-header { background: linear-gradient(90deg, rgba(56,189,248,0.1) 0%, rgba(24,24,27,0) 100%); padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .play-title { font-weight: 900; font-size: 1.3rem; color: white; }
        .formation-tag { font-family: 'JetBrains Mono'; font-size: 0.75rem; color: var(--accent); background: rgba(56,189,248,0.1); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top:5px; }
        .scout-body { padding: 30px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
        .summary-box { grid-column: 1 / -1; background: rgba(255,255,255,0.03); border-left: 4px solid var(--accent); padding: 20px; border-radius: 0 8px 8px 0; color: #d4d4d8; line-height: 1.6; margin-bottom: 10px; }
        
        .tactical-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; grid-column: 1 / -1; }
        .tac-card { background: #27272a; border: 1px solid var(--border); padding: 15px; border-radius: 10px; text-align: left; }
        .tac-label { font-size: 0.7rem; color: #888; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .tac-val { font-size: 1.1rem; font-weight: 800; color: white; font-family: 'JetBrains Mono'; }
        
        .grade-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 25px; grid-column: 1 / -1; }
        .metric-card { background: #27272a; border: 1px solid var(--border); padding: 15px; border-radius: 10px; text-align: center; }
        .metric-label { font-size: 0.75rem; color: #a1a1aa; text-transform: uppercase; font-weight: 700; margin-bottom: 5px; }
        .metric-val { font-size: 1.4rem; font-weight: 800; color: white; font-family: 'JetBrains Mono'; }

        /* MODALS */
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; display:none; justify-content:center; align-items:center; }
        .modal-content { background:#18181b; border:1px solid var(--border); border-radius:16px; overflow:hidden; }
        .modal-content.wide { width:85vw; max-width:900px; max-height:80vh; overflow-y:auto; padding:25px; }
        
        #video-overlay-modal { position:fixed; inset:0; background:rgba(0,0,0,0.98); z-index:3000; display:none; justify-content:center; align-items:center; flex-direction:column; }
        #telestrator-container { position:relative; border:1px solid #333; max-width:90vw; max-height:80vh; }
        #main-video { display:block; max-width:100%; max-height:80vh; }
        #draw-canvas { position:absolute; top:0; left:0; pointer-events:none; }
        
        /* NEW VIDEO SCRUBBER STYLING */
        .video-scrubber-container { width: 90%; max-width: 800px; margin-top: 15px; display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.5); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; }
        #video-scrubber { flex: 1; -webkit-appearance: none; height: 4px; background: #444; border-radius: 2px; outline: none; cursor: pointer; }
        #video-scrubber::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); cursor: pointer; box-shadow: 0 0 10px var(--accent); }
        #video-time { font-family: 'JetBrains Mono'; font-size: 0.8rem; color: #e4e4e7; width: 100px; text-align: right; }

        .tele-controls { margin-top:15px; display:flex; gap:15px; background:#1a1a1a; padding:10px 20px; border-radius:30px; border:1px solid #333; }
        
        /* --- VISUALLY APPEALING COACH CHAT --- */
        #coach-chat-modal { 
            position:fixed; bottom:20px; right:340px; width:400px; height:600px; 
            background:#18181b; border:1px solid #3f3f46; z-index:2000; border-radius:20px; 
            display:none; flex-direction:column; box-shadow: 0 20px 50px rgba(0,0,0,0.7); 
        }
        .chat-header { 
            padding:15px 20px; border-bottom:1px solid #27272a; display:flex; justify-content:space-between; align-items: center; 
            background: #27272a; border-radius: 20px 20px 0 0; 
        }
        .chat-header span { font-weight:800; font-size:1rem; color:white; letter-spacing: -0.5px; }
        .coach-feed { 
            flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:15px; background: #09090b; 
        }
        .coach-msg { 
            padding:12px 16px; border-radius:18px; font-size:0.9rem; max-width:85%; line-height: 1.5; 
            position: relative; word-wrap: break-word; animation: fadeIn 0.2s ease-out;
        }
        .coach-msg.user { 
            align-self:flex-end; background:var(--accent); color:black; 
            border-bottom-right-radius: 4px; font-weight: 600; 
        }
        .coach-msg.model { 
            align-self:flex-start; background:#27272a; color:#e4e4e7; border:1px solid #3f3f46; 
            border-bottom-left-radius: 4px; 
        }
        /* Markdown Bold Support */
        .coach-msg strong { font-weight: 800; color: white; }
        .coach-msg.user strong { color: black; }

        .clip-card { background:var(--bg-card); border:1px solid var(--border); margin-bottom:10px; border-radius:10px; cursor:pointer; position:relative; }
        .clip-thumb { height:100px; background:#000; display:flex; align-items:center; justify-content:center; font-size:2rem; color:#333; border-radius: 10px 10px 0 0; }
        .clip-info { padding:10px; } 
        .clip-menu-btn { position:absolute; top:5px; right:5px; background:rgba(0,0,0,0.6); color:white; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer; display:none; }
        .clip-card:hover .clip-menu-btn { display:block; }
        
        .msg { max-width: 70%; padding: 12px 18px; border-radius: 12px; font-size: 0.95rem; line-height: 1.5; margin-bottom:10px; }
        .msg.user { align-self:flex-end; background:var(--accent); color:black; font-weight:700; }
        .msg.model { align-self: flex-start; }
        
        .menu-opt { padding:12px 20px; border-bottom:1px solid #27272a; cursor:pointer; text-align:left; color:#d4d4d8; transition:0.2s; }
        .menu-opt:hover { color:var(--accent); background:#27272a; padding-left: 25px; }
    </style>
</head>
<body>

    <div class="navbar">
        <div class="logo">Vantage<span>Vision</span></div>
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('about')">The Vision</div>
            <div class="nav-tab" onclick="switchTab('self')">Self Analysis</div>
            <div class="nav-tab" onclick="switchTab('team')">Team Analysis</div>
        </div>
        <div id="user-button"></div>
    </div>

    <div class="view-container">
        <div id="landing-view" class="view active-view">
            <div class="hero-section">
                <h1 class="hero-title">ELITE COACHING.<br>DEMOCRATIZED.</h1>
                <button class="cta-btn" onclick="switchTab('self')">ENTER WAR ROOM</button>
            </div>
        </div>

        <div id="war-room-view" class="view">
            <div id="progress-container"><div id="progress-bar"></div></div>
            
            <div class="app-body">
                <div class="sidebar" id="left-panel">
                    <div style="padding:20px; border-bottom:1px solid var(--border); font-weight:800; color:#888;">SESSIONS <button onclick="newSession()" style="float:right; background:none; border:none; color:white;">+</button></div>
                    <div id="session-list"></div>
                </div>

                <div class="main">
                    <div id="chat-feed" class="chat-feed"></div>
                    <div class="tools-bar">
                        <div class="tools-left"><button class="tool-btn" onclick="toggleSidebar()">‚óÇ Sessions</button></div>
                        <div class="tools-center" id="team-tools-panel" style="display:none;">
                            <button class="tool-btn" onclick="openRoster()">üë• Roster</button>
                            <button class="tool-btn" onclick="openTendencies()">üìä Tendency</button>
                        </div>
                        <div class="tools-right"><button class="tool-btn" onclick="toggleLibrary()">Library ‚ñ∏</button></div>
                    </div>
                    <div class="input-bar">
                        <select id="pos-select" class="pos-select">
                            <option value="general">Select Focus...</option>
                            <option value="qb">Quarterback</option>
                            <option value="wr">Receiver</option>
                            <option value="rb">Running Back</option>
                            <option value="ol">O-Line</option>
                            <option value="dl">D-Line</option>
                            <option value="lb">Linebacker</option>
                            <option value="db">Defensive Back</option>
                        </select>
                        <input type="file" id="file-input" hidden onchange="handleFileSelect(this)">
                        <button id="file-btn" class="btn" style="width:45px; border-radius:50%;" onclick="document.getElementById('file-input').click()">üìé</button>
                        <span id="file-name-display" style="color:#888; font-size:0.8rem; margin-left:10px;"></span>
                        <input type="text" id="user-input" class="input-box" placeholder="Ask the coach...">
                        <button id="send-btn" class="btn">SEND</button>
                    </div>
                </div>

                <div class="lib-panel" id="right-panel">
                    <div style="padding:20px; border-bottom:1px solid var(--border); font-weight:800; color:#888;">FILM LIBRARY</div>
                    <div id="lib-grid" style="padding:10px; overflow-y:auto; flex:1;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="video-overlay-modal">
        <div id="telestrator-container">
            <video id="main-video" crossorigin="anonymous"></video>
            <canvas id="draw-canvas"></canvas>
        </div>
        
        <div class="video-scrubber-container">
            <input type="range" id="video-scrubber" min="0" value="0" step="0.1">
            <div id="video-time">0:00 / 0:00</div>
        </div>

        <div class="tele-controls">
            <button class="tele-btn" onclick="togglePlay()">‚èØ Play/Pause</button>
            <button id="draw-toggle" class="tele-btn" onclick="toggleDrawMode()">‚úèÔ∏è Draw: OFF</button>
            <button class="tele-btn" onclick="clearCanvas()" style="color:#ef4444;">Clear</button>
            <button class="tele-btn" onclick="saveSnapshot()" style="color:var(--success);">üì∏ Save</button>
            <button class="tele-btn" onclick="closeVideoPlayer()">‚úï Close</button>
        </div>
    </div>

    <div id="coach-chat-modal">
        <div class="chat-header">
            <span>Coach's Corner</span>
            <button onclick="document.getElementById('coach-chat-modal').style.display='none'" style="background:none; border:none; color:white; cursor:pointer;">‚úï</button>
        </div>
        <div id="coach-feed" class="coach-feed"></div>
        <div style="padding:15px; border-top:1px solid #333; display:flex; background:#27272a;">
            <input id="coach-input" class="input-box" style="font-size:0.9rem;" placeholder="Ask about specific players or plays...">
            <button onclick="sendCoachMessage()" class="btn" style="margin-left:10px;">></button>
        </div>
    </div>

    <div id="clip-modal" class="modal" onclick="if(event.target === this) this.style.display='none'"><div class="modal-content" style="width:350px;"><div style="display:flex; flex-direction:column;"><div onclick="organizeClip()" class="menu-opt">üìÇ Organize</div><div onclick="openCoachChat()" class="menu-opt">üí¨ Ask Coach</div><div onclick="viewNotes()" class="menu-opt">üìù Scout Report</div><div onclick="deleteClip()" class="menu-opt" style="color:var(--danger);">üóë Delete</div></div></div></div>
    <div id="notes-popup" class="modal" onclick="if(event.target === this) this.style.display='none'"><div class="modal-content wide" style="padding:25px;"><div id="notes-text"></div></div></div>
    <div id="tendency-modal" class="modal" onclick="if(event.target === this) this.style.display='none'"><div class="modal-content wide" style="padding:30px;"><div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h3 style="color:white; margin:0;">Efficiency Report</h3><button onclick="document.getElementById('tendency-modal').style.display='none'" style="background:none; border:none; color:white;">‚úï</button></div><div id="tendency-insights"></div><div id="tendency-content" class="tendency-grid"></div></div></div>
    <div id="roster-modal" class="modal" onclick="if(event.target === this) this.style.display='none'"><div class="modal-content wide" style="padding:25px;"><h3 style="color:white;">Session Roster</h3><div id="roster-grid" style="display:grid; gap:15px; grid-template-columns:repeat(auto-fill, minmax(250px, 1fr));"></div></div></div>
    <div id="auth-modal" class="modal" style="display:flex;"><div id="sign-in" style="background:white; padding:20px; border-radius:10px;"></div></div>

    <script>
        let currentSession = null, currentClip = null, activeSport = 'football', isDrawing = false, scratchCtx = null;
        let sessionClips = [];
        let currentType = 'self';

        function initApp() {
            if (window.Clerk) {
                Clerk.load().then(() => {
                    if (Clerk.user) {
                        document.getElementById('auth-modal').style.display = 'none';
                        Clerk.mountUserButton(document.getElementById('user-button'));
                        document.getElementById('send-btn').addEventListener('click', sendMessage);
                        switchTab('self');
                    } else { Clerk.mountSignIn(document.getElementById('sign-in')); }
                });
            } else { setTimeout(initApp, 500); }
        }
        window.onload = initApp;

        function toggleSidebar() { document.getElementById('left-panel').classList.toggle('collapsed'); }
        function toggleLibrary() { document.getElementById('right-panel').classList.toggle('collapsed'); }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            if(tabName === 'about') {
                document.querySelector('.nav-tab:nth-child(1)').classList.add('active');
                document.getElementById('landing-view').classList.add('active-view');
            } else {
                currentType = tabName; 
                const index = tabName === 'self' ? 2 : 3;
                document.querySelector(`.nav-tab:nth-child(${index})`).classList.add('active');
                document.getElementById('war-room-view').classList.add('active-view');
                document.getElementById('chat-feed').innerHTML = '';
                document.getElementById('lib-grid').innerHTML = '';
                
                document.getElementById('pos-select').style.display = tabName === 'team' ? 'none' : 'block';
                document.getElementById('team-tools-panel').style.display = tabName === 'team' ? 'flex' : 'none';
                
                loadSessions();
            }
        }

        function handleFileSelect(input) {
            const btn = document.getElementById('file-btn');
            const display = document.getElementById('file-name-display');
            if (input.files && input.files[0]) {
                const file = input.files[0];
                btn.innerHTML = '‚úÖ'; btn.style.background = 'var(--success)'; btn.style.color = 'black';
                display.textContent = file.name;
            } else {
                btn.innerHTML = 'üìé'; btn.style.background = ''; btn.style.color = ''; display.textContent = '';
            }
        }

        async function apiFetch(url, body) {
            if (!Clerk.session) return null;
            const token = await Clerk.session.getToken();
            return fetch(url, {
                method: body ? 'POST' : 'GET',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: body ? JSON.stringify(body) : null
            }).then(r => r.json());
        }

        async function loadSessions() {
            const sessions = await apiFetch(`/api/sessions?type=${currentType}`);
            const list = document.getElementById('session-list');
            list.innerHTML = sessions.map(s => 
                `<div class="session-item" id="sess-${s.id}" onclick="selectSession('${s.id}')"><span>${s.title}</span><span onclick="deleteSession('${s.id}')">üóë</span></div>`
            ).join('');
            if(sessions.length > 0 && !currentSession) selectSession(sessions[0].id);
        }
        
        function selectSession(id) {
            document.querySelectorAll('.session-item').forEach(i => i.classList.remove('active'));
            const el = document.getElementById(`sess-${id}`);
            if(el) el.classList.add('active');
            currentSession = id;
            loadChat(id);
        }

        async function newSession() {
            const title = prompt("Session Name:");
            if (title) { await apiFetch('/api/create-session', { title, type: currentType }); loadSessions(); }
        }

        async function deleteSession(id) {
            if(confirm("Delete?")) { await apiFetch('/api/delete-session', { sessionId: id }); loadSessions(); }
        }

        async function loadChat(id) {
            currentSession = id;
            loadLibrary();
            const data = await apiFetch(`/api/session/${id}`);
            const feed = document.getElementById('chat-feed');
            feed.innerHTML = '';
            data.history.forEach(m => renderMessage(m.role, m.text));
        }

        async function loadLibrary() {
            if (!currentSession) return;
            const clips = await apiFetch(`/api/search?sessionId=${currentSession}`);
            sessionClips = clips;
            const grid = document.getElementById('lib-grid');
            grid.innerHTML = '';
            const folders = {};
            clips.forEach(c => {
                const sec = c.section || 'Inbox';
                if (!folders[sec]) folders[sec] = [];
                folders[sec].push(c);
            });
            for(const [name, list] of Object.entries(folders)) {
                grid.innerHTML += `<div class="folder-header" style="color:var(--accent); font-size:0.8rem; font-weight:800; margin:15px 0 5px; text-transform:uppercase;">${name}</div>`;
                list.forEach(c => {
                    grid.innerHTML += `
                        <div class="clip-card">
                            <button class="clip-menu-btn" onclick='openOptions(${JSON.stringify(c).replace(/'/g, "&apos;")})'>‚ãÆ</button>
                            <div class="clip-thumb" onclick="openVideoPlayer('${c.videoUrl}', '${c._id}')">‚ñ∂</div>
                            <div class="clip-info"><div class="clip-title">${c.title}</div></div>
                        </div>`;
                });
            }
        }

        function openOptions(clip) { currentClip = clip; document.getElementById('clip-modal').style.display = 'flex'; }

        function openVideoPlayer(url, id) {
            if(id) currentClip = {_id: id, videoUrl: url};
            const modal = document.getElementById('video-overlay-modal');
            const video = document.getElementById('main-video');
            const canvas = document.getElementById('draw-canvas');
            const scrubber = document.getElementById('video-scrubber');
            
            video.src = url;
            modal.style.display = 'flex';
            
            video.onloadedmetadata = () => {
                canvas.width = video.offsetWidth;
                canvas.height = video.offsetHeight;
                scratchCtx = canvas.getContext('2d');
                scratchCtx.strokeStyle = "#38bdf8"; scratchCtx.lineWidth = 4;
                scrubber.max = video.duration;
            };
            
            video.ontimeupdate = () => {
                scrubber.value = video.currentTime;
                const m = Math.floor(video.currentTime/60);
                const s = Math.floor(video.currentTime%60).toString().padStart(2,'0');
                const dm = Math.floor(video.duration/60);
                const ds = Math.floor(video.duration%60).toString().padStart(2,'0');
                document.getElementById('video-time').innerText = `${m}:${s} / ${dm}:${ds}`;
            };
            
            scrubber.oninput = () => { video.currentTime = scrubber.value; };

            let d = false;
            // Mouse
            canvas.onmousedown = (e) => { if(isDrawing) { d=true; scratchCtx.beginPath(); scratchCtx.moveTo(e.offsetX, e.offsetY); } };
            canvas.onmouseup = () => d=false;
            canvas.onmousemove = (e) => { if(d && isDrawing) { scratchCtx.lineTo(e.offsetX, e.offsetY); scratchCtx.stroke(); } };
            
            // iPad/Touch Support
            canvas.ontouchstart = (e) => {
                if(isDrawing) {
                    e.preventDefault(); 
                    d = true;
                    const rect = canvas.getBoundingClientRect();
                    const x = e.touches[0].clientX - rect.left;
                    const y = e.touches[0].clientY - rect.top;
                    scratchCtx.beginPath(); scratchCtx.moveTo(x, y);
                }
            };
            canvas.ontouchend = (e) => { e.preventDefault(); d = false; };
            canvas.ontouchmove = (e) => {
                if(d && isDrawing) {
                    e.preventDefault(); 
                    const rect = canvas.getBoundingClientRect();
                    const x = e.touches[0].clientX - rect.left;
                    const y = e.touches[0].clientY - rect.top;
                    scratchCtx.lineTo(x, y); scratchCtx.stroke();
                }
            };
        }
        
        function togglePlay() { const v = document.getElementById('main-video'); v.paused ? v.play() : v.pause(); }
        function toggleDrawMode() {
            isDrawing = !isDrawing;
            const btn = document.getElementById('draw-toggle');
            const canvas = document.getElementById('draw-canvas');
            if (isDrawing) {
                btn.innerHTML = "‚úèÔ∏è Draw: ON"; btn.classList.add('active'); canvas.style.pointerEvents = "auto"; document.getElementById('main-video').pause();
            } else {
                btn.innerHTML = "‚úèÔ∏è Draw: OFF"; btn.classList.remove('active'); canvas.style.pointerEvents = "none";
            }
        }
        function clearCanvas() { scratchCtx.clearRect(0, 0, document.getElementById('draw-canvas').width, document.getElementById('draw-canvas').height); }
        async function saveSnapshot() {
            const v = document.getElementById('main-video');
            const c = document.getElementById('draw-canvas');
            const t = document.createElement('canvas'); t.width = v.videoWidth; t.height = v.videoHeight;
            const ctx = t.getContext('2d');
            ctx.drawImage(v, 0, 0, t.width, t.height);
            ctx.drawImage(c, 0, 0, t.width, t.height);
            await apiFetch('/api/save-snapshot', { clipId: currentClip._id, imageData: t.toDataURL('image/jpeg') });
            alert("Snapshot Saved!");
        }
        function closeVideoPlayer() {
            document.getElementById('video-overlay-modal').style.display='none';
            document.getElementById('main-video').pause();
            clearCanvas(); isDrawing = false;
        }

        async function openRoster() {
            if(!currentSession) return alert("Select Session");
            const data = await apiFetch(`/api/session/${currentSession}`);
            const grid = document.getElementById('roster-grid');
            grid.innerHTML = '';
            if(data.roster) {
                data.roster.forEach(p => {
                    grid.innerHTML += `<div class="tac-card"><div class="tac-label">${p.position}</div><div class="tac-val">${p.identifier}</div><div style="font-size:0.8rem; color:#888;">${p.notes[0]}</div></div>`;
                });
            }
            document.getElementById('roster-modal').style.display = 'flex';
        }

        function openTendencies() {
            if(!sessionClips.length) return alert("No clips analyzed yet.");
            let html = '';
            sessionClips.forEach(c => {
                const grade = c.fullData?.scouting_report?.report_card?.overall || "N/A";
                html += `<div style="background:#27272a; padding:10px; border-radius:8px; margin-bottom:5px;">${c.o_formation} - Grade: ${grade}</div>`;
            });
            document.getElementById('tendency-content').innerHTML = html;
            document.getElementById('tendency-modal').style.display = 'flex';
        }

        // *** RENDER FUNCTIONS ***
        function renderScoutCard(data) {
            const r = data.scouting_report || {};
            const grades = r.report_card || {};
            const overallGrade = grades.overall || '-';
            const gradeColor = overallGrade.startsWith('A') ? 'A' : (overallGrade.startsWith('B') ? 'B' : (overallGrade.startsWith('C') ? 'C' : 'D'));

            const timelineHTML = r.timeline ? r.timeline.map(t => `
                <div class="timeline-event">
                    <div class="t-time">${t.time}</div>
                    <div class="t-content">
                        <div class="t-type">${t.type}</div>
                        <div class="t-desc">${t.text}</div>
                    </div>
                </div>`).join('') : '';

            const rx = r.coaching_prescription || {};
            const rxHTML = `
                <div class="rx-panel">
                    <div class="rx-card" style="border-color:var(--danger); background:rgba(239,68,68,0.05);">
                        <div class="rx-header">‚ö° COACHING FIX</div>
                        <div class="rx-item">${rx.fix || 'No immediate fix.'}</div>
                    </div>
                    <div class="rx-card" style="border-color:var(--accent); background:rgba(56,189,248,0.05);">
                        <div class="rx-header" style="color:var(--accent);">üèãÔ∏è DRILL ASSIGNMENT</div>
                        <div class="rx-item">${rx.drill || 'No drill assigned.'}</div>
                    </div>
                    <div class="rx-card" style="border-color:#f59e0b; background:rgba(245,158,11,0.05);">
                        <div class="rx-header" style="color:#f59e0b;">üß† PRO TIP</div>
                        <div class="rx-item">${rx.pro_tip || 'No tip available.'}</div>
                    </div>
                </div>`;

            const playersHTML = data.players_detected ? `
                <div class="players-section">
                    <div class="section-title">ROSTER DETECTED</div>
                    <div class="players-grid">
                        ${data.players_detected.map(p => `
                            <div class="player-mini-card">
                                <div class="pm-header">
                                    <span class="pm-name">${p.identifier} (${p.position})</span>
                                    <span class="pm-grade">${p.grade}</span>
                                </div>
                                <div class="pm-note">${p.observation}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>` : '';

            return `
                <div class="scout-card">
                    <div class="scout-header">
                        <div class="play-meta">
                            <div class="play-title">${data.title || 'Untitled Play'}</div>
                            <div class="formation-tag">${data.data.o_formation} vs ${data.data.d_formation}</div>
                        </div>
                        <div class="overall-badge">
                            <div class="badge-label">OVR</div>
                            <div class="badge-score ${gradeColor}">${overallGrade}</div>
                        </div>
                    </div>
                    <div class="scout-body">
                        <div class="summary-box">${r.summary}</div>
                        <div class="grade-grid">
                            <div class="metric-card"><div class="metric-label">Football IQ</div><div class="metric-val">${grades.football_iq}</div></div>
                            <div class="metric-card"><div class="metric-label">Technique</div><div class="metric-val">${grades.technique}</div></div>
                            <div class="metric-card"><div class="metric-label">Effort</div><div class="metric-val">${grades.effort}</div></div>
                        </div>
                        <div class="timeline-section">
                            <div class="section-title">PLAY BREAKDOWN</div>
                            ${timelineHTML}
                        </div>
                        ${rxHTML}
                        ${playersHTML}
                    </div>
                </div>`;
        }

        function renderTeamCard(data) {
            const t = data.tactical_breakdown || {};
            const r = data.scouting_report || {};
            const rx = r.coaching_prescription || {};
            const timelineHTML = r.timeline ? r.timeline.map(item => `
                <div class="timeline-event">
                    <div class="t-time">${item.time}</div>
                    <div class="t-content"><div class="t-type">${item.type}</div><div class="t-desc">${item.text}</div></div>
                </div>`).join('') : '';

            return `
                <div class="scout-card" style="border-color:#f59e0b;">
                    <div class="scout-header" style="background:rgba(245,158,11,0.1);">
                        <div class="play-meta">
                            <div class="play-title">${data.title}</div>
                            <div class="formation-tag" style="color:#f59e0b; background:rgba(245,158,11,0.1); border-color:rgba(245,158,11,0.3);">${data.data.o_formation} vs ${data.data.d_formation}</div>
                        </div>
                        <div class="overall-badge" style="border-color:#f59e0b;">
                            <div class="badge-label" style="color:#f59e0b;">TEAM</div>
                            <div class="badge-score" style="color:#f59e0b; font-size:1.5rem;">XO</div>
                        </div>
                    </div>
                    <div class="scout-body">
                        <div class="tactical-grid">
                            <div class="tac-card highlight"><div class="tac-label">CONCEPT</div><div class="tac-val">${t.concept}</div></div>
                            <div class="tac-card"><div class="tac-label">BOX COUNT</div><div class="tac-val">${t.box_count}</div></div>
                            <div class="tac-card"><div class="tac-label">COVERAGE</div><div class="tac-val">${t.coverage_shell}</div></div>
                            <div class="tac-card highlight"><div class="tac-label">KEY MATCHUP</div><div class="tac-val" style="font-size:0.8rem;">${t.key_matchup}</div></div>
                        </div>
                        <div class="summary-box" style="border-left-color:#f59e0b;">${r.summary}</div>
                        <div class="timeline-section"><div class="section-title" style="color:#f59e0b;">SCHEMATIC TIMELINE</div>${timelineHTML}</div>
                        <div class="rx-panel"><div class="rx-card" style="border-color:#f59e0b; background:rgba(245,158,11,0.05);"><div class="rx-header" style="color:#f59e0b;">üìã COORDINATOR NOTE</div><div class="rx-item">${rx.fix}</div></div></div>
                    </div>
                </div>`;
        }

        function renderMessage(role, text) {
            const feed = document.getElementById('chat-feed');
            if (!text) return;
            let content = text;
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            if(role === 'model' && text.includes('{')) {
                try {
                    const j = JSON.parse(text);
                    content = j.tactical_breakdown ? renderTeamCard(j) : renderScoutCard(j);
                } catch(e) { }
            }
            feed.innerHTML += `<div class="msg ${role}">${content}</div>`;
            feed.scrollTop = feed.scrollHeight;
        }

        async function sendMessage() {
            const txt = document.getElementById('user-input').value;
            const file = document.getElementById('file-input').files[0];
            const sendBtn = document.getElementById('send-btn');
            const pos = currentType === 'team' ? 'team' : document.getElementById('pos-select').value;
            if(!txt && !file) return;
            if(!currentSession) return alert("Select Session");

            sendBtn.innerHTML = "‚è≥ Processing..."; sendBtn.disabled = true;
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('progress-bar').style.width = '30%';

            renderMessage('user', txt || "Analyzing...");
            document.getElementById('user-input').value = '';

            const payload = { message: txt, sessionId: currentSession, sport: 'football', position: pos };
            
            const handleResponse = async (res) => {
                document.getElementById('progress-bar').style.width = '100%';
                if (res.error) renderMessage('model', "‚ö†Ô∏è Error: " + res.error);
                else if (res.reply) { if(res.newClip) loadLibrary(); renderMessage('model', res.reply); }
                
                document.getElementById('file-input').value = '';
                document.getElementById('file-btn').innerHTML = 'üìé'; 
                document.getElementById('file-btn').style.background = ''; 
                document.getElementById('file-btn').style.color = ''; 
                document.getElementById('file-name-display').textContent = '';
                
                setTimeout(() => document.getElementById('progress-container').style.display='none', 500);
                sendBtn.innerHTML = "SEND"; sendBtn.disabled = false;
            };

            const handleError = (e) => {
                console.error(e); alert("Upload Failed.");
                sendBtn.innerHTML = "SEND"; sendBtn.disabled = false;
                document.getElementById('progress-container').style.display='none';
            };

            if(file) {
                const r = new FileReader();
                r.onload = async () => {
                    try {
                        payload.fileData = r.result.split(',')[1]; payload.mimeType = file.type;
                        const res = await apiFetch('/api/chat', payload);
                        handleResponse(res);
                    } catch(e) { handleError(e); }
                };
                r.onerror = handleError;
                r.readAsDataURL(file);
            } else {
                try {
                    const res = await apiFetch('/api/chat', payload);
                    handleResponse(res);
                } catch(e) { handleError(e); }
            }
        }
        
        async function openCoachChat() {
            document.getElementById('coach-chat-modal').style.display = 'flex';
            document.getElementById('coach-feed').innerHTML = '';
            if(currentClip) {
               const data = await apiFetch(`/api/clip/${currentClip._id}`);
               if(data.chatHistory) data.chatHistory.forEach(m => {
                   let txt = m.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                   document.getElementById('coach-feed').innerHTML += `<div class="coach-msg ${m.role}">${txt}</div>`;
               });
            }
        }
        
        async function sendCoachMessage() {
            const msg = document.getElementById('coach-input').value;
            if(!msg) return;
            document.getElementById('coach-feed').innerHTML += `<div class="coach-msg user">${msg}</div>`;
            document.getElementById('coach-input').value = '';
            const res = await apiFetch('/api/clip-chat', { message: msg, clipId: currentClip._id });
            let txt = res.reply.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            document.getElementById('coach-feed').innerHTML += `<div class="coach-msg model">${txt}</div>`;
        }
        
        async function deleteClip() {
            if(confirm("Delete?")) await apiFetch('/api/delete-clip', { id: currentClip._id });
            loadLibrary();
            document.querySelectorAll('.modal').forEach(m=>m.style.display='none');
        }
        
        function viewNotes() {
            const d = currentClip.fullData;
            document.getElementById('notes-text').innerHTML = d.tactical_breakdown ? renderTeamCard(d) : renderScoutCard(d);
            document.getElementById('notes-popup').style.display = 'flex';
        }
        
        async function organizeClip() {
            const folder = prompt("New Folder Name:");
            if (folder) await apiFetch('/api/update-clip', { id: currentClip._id, section: folder });
            closeModal(); loadLibrary();
        }
    </script>
</body>
</html>
