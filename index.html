<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sideline Pro | Analytics Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050a05; --panel: #0a140a; --border: #142914; 
            --accent: #009933; --accent-glow: #00cc44; --text: #e0e0e0; 
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 4px; }
        
        .app-container { display: flex; width: 100%; height: 100%; }
        
        .sidebar { width: 260px; background: #020502; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-header { padding: 25px; font-family: 'JetBrains Mono'; color: var(--accent-glow); font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .btn-new { background: var(--accent); color: #000; border: none; padding: 12px; margin: 0 15px 10px; border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .session-list { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .session-item { padding: 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: #88a; font-size: 0.9rem; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .session-item.active { background: #0f1f0f; color: var(--accent); border-left: 2px solid var(--accent); }
        .credits-panel { padding: 20px; border-top: 1px solid var(--border); background: #020502; }
        .buy-btn { width: 100%; background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 8px; font-weight: bold; }

        .chat-section { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .header-top { padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #0a140a; }
        .session-title { font-weight: 800; font-size: 1.1rem; color: white; }
        #chat-window { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 25px; }
        .message { padding: 20px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; max-width: 800px; animation: fadeIn 0.3s; }
        .user-msg { align-self: flex-end; background: #1a2e1a; color: white; border-right: 3px solid var(--accent); }
        .ai-msg { align-self: flex-start; color: #ccc; width: 100%; border-left: 3px solid #333; padding-left: 25px; }

        /* LIBRARY STYLES */
        .library-section { width: 350px; background: #0a140a; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .lib-header { padding: 20px; font-weight: 800; color: #668866; border-bottom: 1px solid var(--border); font-size: 0.8rem; letter-spacing: 1px; }
        .section-header { padding: 10px 20px; background: #111; color: var(--accent); font-size: 0.8rem; font-weight: bold; margin-top: 10px; display: flex; justify-content: space-between; }
        .play-card { background: #050a05; border: 1px solid #1a2e1a; padding: 15px; margin: 10px 15px; border-radius: 6px; transition: 0.2s; position: relative; }
        .play-card:hover { border-color: var(--accent); }
        .card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .small-btn { background: #1a2e1a; border: none; color: #ccc; padding: 5px; font-size: 0.7rem; cursor: pointer; border-radius: 3px; }
        .small-btn:hover { background: var(--accent); color: black; }
        .delete-btn { color: #ff5555; background: #221111; }
        .delete-btn:hover { background: #ff5555; color: white; }

        .input-area { padding: 25px; display: flex; gap: 15px; align-items: center; background: #0a140a; border-top: 1px solid var(--border); }
        input[type="text"] { background: #050a05; border: 1px solid #1a2e1a; color: white; padding: 15px; border-radius: 6px; flex: 1; outline: none; font-size: 1rem; }
        .file-btn, .send-btn { cursor: pointer; border-radius: 6px; }
        .file-btn { background: #1a2e1a; color: #88a; width: 50px; height: 50px; border: 1px solid #1a331a; font-size: 1.2rem; }
        .send-btn { background: var(--accent); color: black; border: none; padding: 0 30px; font-weight: 800; height: 50px; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #0a140a; padding: 30px; border: 1px solid #1a2e1a; border-radius: 12px; width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; font-weight: bold; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header"><span>âš¡</span> SIDELINE PRO</div>
        <button class="btn-new" onclick="createNewChat()">+ New Session</button>
        <div id="session-list" class="session-list"></div>
        <div class="credits-panel">
            <span id="credit-display" style="color:white; font-weight:bold;">--</span> Credits
            <button class="buy-btn" onclick="buyCredits()">+ 50 Credits ($15)</button>
            <div style="margin-top:10px; font-size:0.7rem; color:#444; cursor:pointer;" onclick="logout()">LOGOUT</div>
        </div>
    </div>

    <div class="chat-section">
        <div class="header-top">
            <span id="current-chat-title" class="session-title">Select a Session</span>
            <button onclick="generateSessionSummary()" style="background:#1a2e1a; border:1px solid #1a331a; color:var(--accent); padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.8rem;">ðŸ“„ SESSION REPORT</button>
        </div>
        <div id="chat-window"><div class="message ai-msg">System Online. Ready for analysis.</div></div>
        <div class="input-area">
            <input type="file" id="file-input" accept="video/*" style="display:none;">
            <button class="file-btn" onclick="document.getElementById('file-input').click()">ðŸ“Ž</button>
            <input type="text" id="user-input" placeholder="Analyze this play..." autocomplete="off">
            <button class="send-btn" id="send-btn">SEND</button>
        </div>
    </div>

    <div class="library-section">
        <div class="lib-header">SESSION CLIPS</div>
        <div id="library-content" style="flex:1; overflow-y: auto;"></div>
    </div>
</div>

<div id="auth-modal" class="modal" style="display:flex;">
    <div class="modal-box" style="width:350px;">
        <div class="modal-title">SIDELINE PRO</div>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email" style="width:100%; padding:15px; margin-bottom:10px; background:#000; border:1px solid #333; color:white;">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Password" style="width:100%; padding:15px; margin-bottom:10px; background:#000; border:1px solid #333; color:white;">
        <button class="btn-new" style="width:100%; margin:0;" onclick="handleAuth('login')">LOGIN</button>
        <button class="buy-btn" style="border:none; margin-top:10px;" onclick="handleAuth('signup')">Create Account</button>
    </div>
</div>

<div id="video-modal" class="modal">
    <div class="modal-box" style="width:800px; text-align:center;">
        <div class="modal-title">VIDEO REVIEW</div>
        <video id="main-player" controls style="width:100%; border:2px solid var(--accent); border-radius:8px;"></video>
        <button class="buy-btn" onclick="closeModals()" style="margin-top:20px;">CLOSE</button>
    </div>
</div>

<div id="report-modal" class="modal">
    <div class="modal-box">
        <div class="modal-title">SCOUTING REPORT</div>
        <div id="report-content" style="color:#ccc; line-height:1.6;"></div>
        <button class="buy-btn" onclick="closeModals()" style="margin-top:20px;">CLOSE</button>
    </div>
</div>

<div id="chat-modal" class="modal">
    <div class="modal-box">
        <div class="modal-title">CLIP WAR ROOM</div>
        <div id="clip-chat-history" style="height:300px; overflow-y:auto; background:#000; padding:10px; margin-bottom:10px; border-radius:4px;"></div>
        <input type="text" id="clip-chat-input" placeholder="Ask specific question..." style="width:100%;">
        <button class="btn-new" style="width:100%; margin-top:10px;" onclick="sendClipMessage()">ASK</button>
        <button class="buy-btn" onclick="closeModals()">CLOSE</button>
    </div>
</div>

<script>
    let currentUser = localStorage.getItem('sideline_user');
    let currentSessionId = null;
    let currentClipId = null; // For war room
    let libraryData = [];

    window.onload = () => {
        if (!currentUser) document.getElementById('auth-modal').style.display = 'flex';
        else { loadSessions(); loadLibrary(); refreshCredits(); }
    };

    // --- AUTH ---
    async function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const res = await fetch(`/api/${type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            currentUser = email;
            localStorage.setItem('sideline_user', email);
            document.getElementById('auth-modal').style.display = 'none';
            loadSessions(); loadLibrary(); refreshCredits();
        } else alert(data.error);
    }
    function logout() { localStorage.removeItem('sideline_user'); location.reload(); }
    async function refreshCredits() {
        const res = await fetch('/api/balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser })
        });
        const data = await res.json();
        document.getElementById('credit-display').textContent = data.credits;
    }
    async function buyCredits() {
        const res = await fetch('/api/buy-credits', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser })
        });
        const data = await res.json();
        if(data.success && data.url) window.location.href = data.url;
        else if(data.success) { alert(data.message); refreshCredits(); }
    }

    // --- APP LOGIC ---
    async function loadSessions() {
        const res = await fetch(`/api/sessions?email=${currentUser}`);
        const sessions = await res.json();
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        sessions.forEach(s => {
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `<span onclick="loadChat('${s.id}', '${s.title}')" style="flex:1">${s.title}</span>`;
            list.appendChild(div);
        });
    }

    async function loadChat(id, title) {
        currentSessionId = id;
        document.getElementById('current-chat-title').textContent = title;
        loadSessions();
        const res = await fetch(`/api/session/${id}`);
        const history = await res.json();
        const win = document.getElementById('chat-window');
        win.innerHTML = '';
        history.forEach(msg => addMessage(msg.text, msg.role));
        loadLibrary();
    }

    async function createNewChat() {
        currentSessionId = Math.random().toString(36).substr(2, 9);
        document.getElementById('chat-window').innerHTML = '<div class="message ai-msg">System Online.</div>';
        document.getElementById('library-content').innerHTML = '';
        loadSessions();
    }

    document.getElementById('send-btn').addEventListener('click', async () => {
        const text = document.getElementById('user-input').value;
        const file = document.getElementById('file-input').files[0];
        if(!text && !file) return;
        if(!currentSessionId) createNewChat();

        addMessage(text || "Analyzing...", 'user');
        document.getElementById('user-input').value = '';
        
        const payload = { message: text, sessionId: currentSessionId, email: currentUser };
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                payload.fileData = reader.result.split(',')[1];
                payload.mimeType = file.type;
                sendPayload(payload);
            };
        } else { sendPayload(payload); }
    });

    async function sendPayload(payload) {
        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if(data.error) addMessage(data.error, 'model');
            else {
                addMessage(data.reply, 'model');
                if(data.newClip) loadLibrary();
                refreshCredits();
            }
        } catch(e) { addMessage("Connection error", 'model'); }
    }

    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        div.textContent = text;
        document.getElementById('chat-window').appendChild(div);
    }

    // --- LIBRARY & FEATURES ---
    async function loadLibrary() {
        const res = await fetch(`/api/search?email=${currentUser}&sessionId=${currentSessionId}`);
        libraryData = await res.json();
        
        const content = document.getElementById('library-content');
        content.innerHTML = '';
        
        // Group by Section
        const groups = {};
        libraryData.forEach(clip => {
            const sec = clip.section || "General";
            if(!groups[sec]) groups[sec] = [];
            groups[sec].push(clip);
        });

        Object.keys(groups).forEach(section => {
            const header = document.createElement('div');
            header.className = 'section-header';
            header.textContent = section;
            content.appendChild(header);

            groups[section].forEach(clip => {
                const div = document.createElement('div');
                div.className = 'play-card';
                div.innerHTML = `
                    <div style="font-weight:bold; color:white;">${clip.title}</div>
                    <div style="font-size:0.7rem; color:#666;">${clip.formation} vs ${clip.coverage}</div>
                    <div class="card-actions">
                        <button class="small-btn" onclick="playVideo('${clip.id}')">â–¶ WATCH</button>
                        <button class="small-btn" onclick="viewReport('${clip.id}')">ðŸ“„ REPORT</button>
                        <button class="small-btn" onclick="openClipChat('${clip.id}')">ðŸ’¬ ASK</button>
                        <button class="small-btn" onclick="changeSection('${clip.id}')">ðŸ“‚ MOVE</button>
                        <button class="small-btn delete-btn" onclick="deleteClip('${clip.id}')">ðŸ—‘</button>
                    </div>
                `;
                content.appendChild(div);
            });
        });
    }

    function playVideo(id) {
        document.getElementById('main-player').src = `/plays/${id}`;
        document.getElementById('video-modal').style.display = 'flex';
    }

    function viewReport(id) {
        const clip = libraryData.find(c => c.id === id);
        const report = clip.fullData?.scouting_report || {};
        document.getElementById('report-content').innerHTML = `
            <h3>Summary</h3><p>${report.summary}</p>
            <h3>Action Plan</h3><p>${report.action_plan}</p>
            <h3>Mistakes</h3><ul>${(report.mistakes||[]).map(m=>`<li>${m}</li>`).join('')}</ul>
        `;
        document.getElementById('report-modal').style.display = 'flex';
    }

    function openClipChat(id) {
        currentClipId = id;
        document.getElementById('clip-chat-history').innerHTML = '';
        document.getElementById('chat-modal').style.display = 'flex';
    }

    async function sendClipMessage() {
        const msg = document.getElementById('clip-chat-input').value;
        const clip = libraryData.find(c => c.id === currentClipId);
        
        document.getElementById('clip-chat-history').innerHTML += `<div style="color:white; margin:5px;">User: ${msg}</div>`;
        document.getElementById('clip-chat-input').value = '';

        const res = await fetch('/api/clip-chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ message: msg, context: clip })
        });
        const data = await res.json();
        document.getElementById('clip-chat-history').innerHTML += `<div style="color:#009933; margin:5px;">AI: ${data.reply}</div>`;
    }

    async function deleteClip(id) {
        if(!confirm("Delete this clip?")) return;
        await fetch('/api/delete-clip', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ id, owner: currentUser })
        });
        loadLibrary();
    }

    async function changeSection(id) {
        const sec = prompt("Enter new section name (e.g., Redzone):");
        if(sec) {
            await fetch('/api/update-clip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, section: sec, owner: currentUser })
            });
            loadLibrary();
        }
    }

    async function generateSessionSummary() {
        const res = await fetch('/api/session-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser, sessionId: currentSessionId })
        });
        const data = await res.json();
        addMessage(data.report, 'model');
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(el => {
            if(el.id !== 'auth-modal') el.style.display = 'none';
        });
        document.getElementById('main-player').pause();
    }
</script>
</body>
</html>
