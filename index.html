<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sideline Pro | Secure Elite Analytics</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050a05; --panel: #0a140a; --border: #142914; --accent: #009933; --accent-glow: #00cc44; --text: #e0e0e0; }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 4px; }
        
        .app-container { display: flex; width: 100%; height: 100%; }
        
        .sidebar { width: 260px; background: #020502; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-header { padding: 25px; font-family: 'JetBrains Mono'; color: var(--accent-glow); font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .btn-new { background: var(--accent); color: #000; border: none; padding: 12px; margin: 0 15px 10px; border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .session-list { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .session-item { padding: 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: #88a; font-size: 0.9rem; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .session-item.active { background: #0f1f0f; color: var(--accent); border-left: 2px solid var(--accent); }
        .edit-icon { opacity: 0; font-size: 0.8rem; cursor: pointer; }
        .session-item:hover .edit-icon { opacity: 1; }
        .credits-panel { padding: 20px; border-top: 1px solid var(--border); background: #020502; }
        .buy-btn { width: 100%; background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 8px; font-weight: bold; }

        .chat-section { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .header-top { padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #0a140a; }
        .session-title { font-weight: 800; font-size: 1.1rem; color: white; display: flex; align-items: center; gap: 10px;}
        
        #chat-window { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 25px; }
        .message { padding: 20px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; max-width: 800px; animation: fadeIn 0.3s; }
        .user-msg { align-self: flex-end; background: #1a2e1a; color: white; border-right: 3px solid var(--accent); }
        .ai-msg { align-self: flex-start; color: #ccc; width: 100%; border-left: 3px solid #333; padding-left: 25px; }

        /* SCOUT REPORT CARD STYLING */
        .scout-card { background: #0e1c0e; border: 1px solid #1a331a; border-radius: 8px; padding: 25px; margin-top: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .scout-header { display: flex; justify-content: space-between; border-bottom: 1px solid #1a331a; padding-bottom: 15px; margin-bottom: 20px; }
        .scout-title { font-weight: 800; color: var(--accent); font-size: 1.2rem; text-transform: uppercase; }
        
        .report-section { margin-bottom: 20px; }
        .section-label { color: #668866; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .section-text { color: #e0e0e0; line-height: 1.5; }
        
        .mistake-list { list-style: none; padding: 0; }
        .mistake-list li { color: #ff5555; margin-bottom: 5px; display: flex; gap: 10px; }
        .mistake-list li::before { content: "‚úñ"; font-weight: bold; }
        
        .action-list { color: var(--accent-glow); margin-top: 5px; }
        
        .action-row { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #1a331a; }
        .card-btn { flex: 1; background: #1a331a; border: 1px solid var(--accent); color: var(--accent); padding: 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; font-weight: bold; text-align: center; text-decoration: none; }
        .card-btn:hover { background: var(--accent); color: black; }

        /* PROGRESS BAR */
        .progress-bar { width: 100%; height: 4px; background: #111; margin-top: 10px; display: none; overflow: hidden; position: relative; }
        .progress-fill { height: 100%; background: var(--accent); width: 50%; position: absolute; animation: load 2s infinite ease-in-out; }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

        .input-area { padding: 25px; display: flex; gap: 15px; align-items: center; background: #0a140a; border-top: 1px solid var(--border); }
        input[type="text"] { background: #050a05; border: 1px solid #1a2e1a; color: white; padding: 15px; border-radius: 6px; flex: 1; outline: none; font-size: 1rem; }
        .file-btn { background: #1a2e1a; color: #88a; width: 50px; height: 50px; border: 1px solid #1a331a; font-size: 1.2rem; cursor: pointer; border-radius: 6px; }
        .send-btn { background: var(--accent); color: black; border: none; padding: 0 30px; font-weight: 800; height: 50px; cursor: pointer; border-radius: 6px; }
        
        /* LIBRARY & MODALS */
        .library-section { width: 350px; background: #0a140a; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .lib-header { padding: 20px; font-weight: 800; color: #668866; border-bottom: 1px solid var(--border); font-size: 0.8rem; letter-spacing: 1px; }
        .section-title { font-size: 0.75rem; font-weight: 700; color: var(--accent); text-transform: uppercase; margin: 15px 15px 5px; letter-spacing: 0.5px; }
        .play-card { background: #050a05; border: 1px solid #1a2e1a; padding: 15px; margin: 5px 15px 15px; border-radius: 6px; cursor: pointer; }
        .play-card:hover { border-color: var(--accent); }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-box { background: #0a140a; padding: 30px; border: 1px solid #1a2e1a; border-radius: 12px; width: 600px; max-height: 90vh; overflow-y: auto; }
        .auth-input { width: 100%; padding: 15px; margin-bottom: 10px; background:#000; border:1px solid #333; color:white; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header"><span>‚ö°</span> SIDELINE PRO</div>
        <button class="btn-new" onclick="createNewChat()">+ New Session</button>
        <div id="session-list" class="session-list"></div>
        <div class="credits-panel">
            <span id="credit-display" style="color:white; font-weight:bold;">--</span> Credits
            <button class="buy-btn" onclick="buyCredits()">+ 50 Credits (Free)</button>
            <div style="margin-top:10px; font-size:0.7rem; color:#444; cursor:pointer;" onclick="logout()">LOGOUT</div>
        </div>
    </div>

    <div class="chat-section">
        <div class="header-top">
            <span id="current-chat-title" class="session-title">Select a Session <span onclick="renameCurrentSession()" style="cursor:pointer; font-size:0.8rem; margin-left:10px; opacity:0.5;">‚úèÔ∏è</span></span>
            <button onclick="generateSessionSummary()" style="background:#1a2e1a; border:1px solid #1a331a; color:var(--accent); padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.8rem;">üìÑ SESSION REPORT</button>
        </div>
        
        <div id="chat-window">
            <div class="message ai-msg">System Online. Ready for analysis.</div>
        </div>
        
        <div id="progress-container" class="progress-bar">
            <div class="progress-fill"></div>
        </div>

        <div class="input-area">
            <input type="file" id="file-input" accept="video/*" style="display:none;">
            <button class="file-btn" onclick="document.getElementById('file-input').click()">üìé</button>
            <input type="text" id="user-input" placeholder="Analyze this play..." autocomplete="off">
            <button class="send-btn" id="send-btn">SEND</button>
        </div>
    </div>

    <div class="library-section">
        <div class="lib-header">SESSION CLIPS</div>
        <div id="library-content" style="flex:1; overflow-y: auto;"></div>
    </div>
</div>

<div id="auth-modal" class="modal" style="display:flex;">
    <div class="modal-box" style="width:350px;">
        <div style="font-size:1.5rem; font-weight:bold; color:var(--accent); margin-bottom:20px;">SIDELINE PRO</div>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
        <button class="btn-new" style="width:100%; margin:0;" onclick="handleAuth('login')">LOGIN</button>
        <button class="buy-btn" style="border:none; margin-top:10px;" onclick="handleAuth('signup')">Create Account (Unlimited Credits)</button>
    </div>
</div>

<div id="video-modal" class="modal">
    <div class="modal-box" style="width:800px; text-align:center;">
        <video id="main-player" controls style="width:100%; border:2px solid var(--accent); border-radius:8px;"></video>
        <button class="buy-btn" onclick="closeModals()" style="margin-top:20px;">CLOSE</button>
    </div>
</div>

<div id="chat-modal" class="modal">
    <div class="modal-box">
        <div style="font-weight:bold; color:var(--accent); margin-bottom:10px;">CLIP WAR ROOM</div>
        <div id="clip-chat-history" style="height:300px; overflow-y:auto; background:#000; padding:10px; margin-bottom:10px; border-radius:4px;"></div>
        <input type="text" id="clip-chat-input" placeholder="Ask specific question..." style="width:100%; background:#111; color:white; border:1px solid #333; padding:10px;">
        <button class="btn-new" style="width:100%; margin-top:10px;" onclick="sendClipMessage()">ASK</button>
        <button class="buy-btn" onclick="closeModals()">CLOSE</button>
    </div>
</div>

<script>
    let authToken = localStorage.getItem('sideline_token');
    let currentSessionId = null;
    let currentClipId = null;
    let libraryData = [];

    // Helper for authenticated fetch
    async function apiFetch(url, options = {}) {
        if (!options.headers) options.headers = {};
        options.headers['Authorization'] = `Bearer ${authToken}`;
        options.headers['Content-Type'] = 'application/json';
        return fetch(url, options);
    }

    window.onload = () => {
        if (!authToken) document.getElementById('auth-modal').style.display = 'flex';
        else { loadSessions(); loadLibrary(); refreshCredits(); }
    };

    // --- AUTH ---
    async function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const res = await fetch(`/api/${type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            authToken = data.token;
            localStorage.setItem('sideline_token', authToken);
            document.getElementById('auth-modal').style.display = 'none';
            loadSessions(); loadLibrary(); refreshCredits();
        } else alert(data.error);
    }
    
    function logout() { localStorage.removeItem('sideline_token'); location.reload(); }
    
    async function refreshCredits() {
        const res = await apiFetch('/api/balance', { method: 'GET' });
        const data = await res.json();
        document.getElementById('credit-display').textContent = data.credits;
    }

    async function buyCredits() {
        const res = await apiFetch('/api/buy-credits', { method: 'POST', body: JSON.stringify({}) });
        const data = await res.json();
        if(data.success) { alert(data.message); refreshCredits(); }
    }

    // --- SESSIONS ---
    async function loadSessions() {
        const res = await apiFetch('/api/sessions');
        const sessions = await res.json();
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        sessions.forEach(s => {
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `<span onclick="loadChat('${s.id}', '${s.title}')" style="flex:1">${s.title}</span><span class="edit-icon" onclick="renameSession('${s.id}')">‚úèÔ∏è</span>`;
            list.appendChild(div);
        });
    }

    async function createNewChat() {
        currentSessionId = Math.random().toString(36).substr(2, 9);
        document.getElementById('current-chat-title').textContent = "New Session";
        document.getElementById('chat-window').innerHTML = '<div class="message ai-msg">System Online.</div>';
        document.getElementById('library-content').innerHTML = '';
        loadSessions();
    }

    async function loadChat(id, title) {
        currentSessionId = id;
        document.getElementById('current-chat-title').textContent = title;
        loadSessions();
        const res = await apiFetch(`/api/session/${id}`);
        const history = await res.json();
        const win = document.getElementById('chat-window');
        win.innerHTML = '';
        history.forEach(msg => addMessage(msg.text, msg.role));
        loadLibrary();
    }

    async function renameSession(id) {
        const newName = prompt("Rename Session:");
        if(newName) {
            await apiFetch('/api/rename-session', { method: 'POST', body: JSON.stringify({ sessionId: id, newTitle: newName }) });
            loadSessions();
        }
    }
    
    function renameCurrentSession() { if(currentSessionId) renameSession(currentSessionId); }

    // --- CHAT & ANALYSIS ---
    document.getElementById('send-btn').addEventListener('click', async () => {
        const text = document.getElementById('user-input').value;
        const file = document.getElementById('file-input').files[0];
        if(!text && !file) return;
        if(!currentSessionId) createNewChat();

        addMessage(text || "Analyzing...", 'user');
        document.getElementById('user-input').value = '';
        document.getElementById('progress-container').style.display = 'block';

        const payload = { message: text, sessionId: currentSessionId };
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                payload.fileData = reader.result.split(',')[1];
                payload.mimeType = file.type;
                sendPayload(payload);
            };
        } else { sendPayload(payload); }
    });

    async function sendPayload(payload) {
        try {
            const res = await apiFetch('/api/chat', { method: 'POST', body: JSON.stringify(payload) });
            const data = await res.json();
            document.getElementById('progress-container').style.display = 'none';
            if(data.error) addMessage(data.error, 'model');
            else {
                addMessage(data.reply, 'model');
                if(data.newClip) loadLibrary();
                refreshCredits();
            }
        } catch(e) { 
            document.getElementById('progress-container').style.display = 'none';
            addMessage("Connection error", 'model'); 
        }
    }

    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        if (role === 'model') {
            try {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const jsonString = text.substring(firstBrace, lastBrace + 1);
                    const data = JSON.parse(jsonString);
                    div.innerHTML = renderScoutCard(data);
                } else { div.textContent = text; }
            } catch(e) { div.textContent = text; }
        } else { div.textContent = text; }
        const win = document.getElementById('chat-window');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    // --- SCOUT CARD & LIBRARY ---
    function renderScoutCard(data) {
        const r = data.scouting_report || {};
        return `
            <div class="scout-card">
                <div class="scout-header">
                    <div class="scout-title">${data.title}</div>
                    <div style="color:#666; font-size:0.8rem;">${data.data?.formation} vs ${data.data?.coverage}</div>
                </div>
                <div class="report-section"><div class="section-label">SUMMARY</div><div class="section-text">${r.summary}</div></div>
                <div class="report-section"><div class="section-label" style="color:#ff5555">MISTAKES</div><ul class="mistake-list">${(r.mistakes||[]).map(m=>`<li>${m}</li>`).join('')}</ul></div>
                <div class="report-section"><div class="section-label" style="color:var(--accent-glow)">PLAN</div><div class="section-text action-list">${r.action_plan}</div></div>
                <div class="action-row"><button onclick="playVideo('${data.id}')" class="card-btn">WATCH</button><div class="card-btn" onclick="openClipChat('${data.id}')">ASK</div></div>
            </div>`;
    }

    async function loadLibrary() {
        const res = await apiFetch(`/api/search?sessionId=${currentSessionId}`, { method: 'GET' });
        libraryData = await res.json();
        const lib = document.getElementById('library-content');
        lib.innerHTML = '';
        
        const groups = {};
        libraryData.forEach(clip => {
            const sec = clip.section || "General";
            if(!groups[sec]) groups[sec] = [];
            groups[sec].push(clip);
        });

        Object.keys(groups).forEach(section => {
            lib.innerHTML += `<div class="section-title">${section}</div>`;
            groups[section].forEach(clip => {
                const div = document.createElement('div');
                div.className = 'play-card';
                div.innerHTML = `
                    <div style="font-weight:bold; color:white;">${clip.title}</div>
                    <div style="font-size:0.7rem; color:#666;">${clip.formation} vs ${clip.coverage}</div>
                    <div style="display:flex; gap:5px; margin-top:8px;">
                        <button class="buy-btn" style="padding:4px; font-size:0.6rem;" onclick="openClipChat('${clip.id}')">CHAT</button>
                        <button class="buy-btn" style="padding:4px; font-size:0.6rem;" onclick="changeSection('${clip.id}')">MOVE</button>
                        <button class="buy-btn" style="padding:4px; font-size:0.6rem; border-color:#ff5555; color:#ff5555;" onclick="deleteClip('${clip.id}')">DEL</button>
                    </div>
                `;
                lib.appendChild(div);
            });
        });
    }

    function playVideo(id) {
        document.getElementById('main-player').src = `/plays/${id}`;
        document.getElementById('video-modal').style.display = 'flex';
    }

    function openClipChat(id) {
        currentClipId = id;
        document.getElementById('clip-chat-history').innerHTML = '';
        document.getElementById('chat-modal').style.display = 'flex';
    }

    async function sendClipMessage() {
        const msg = document.getElementById('clip-chat-input').value;
        const clip = libraryData.find(c => c.id === currentClipId);
        document.getElementById('clip-chat-history').innerHTML += `<div style="color:white; margin:5px;">User: ${msg}</div>`;
        document.getElementById('clip-chat-input').value = '';
        const res = await apiFetch('/api/clip-chat', { method: 'POST', body: JSON.stringify({ message: msg, context: clip }) });
        const data = await res.json();
        document.getElementById('clip-chat-history').innerHTML += `<div style="color:var(--accent); margin:5px;">AI: ${data.reply}</div>`;
    }

    async function deleteClip(id) {
        if(!confirm("Delete?")) return;
        await apiFetch('/api/delete-clip', { method: 'POST', body: JSON.stringify({ id }) });
        loadLibrary();
    }

    async function changeSection(id) {
        const sec = prompt("Folder Name:");
        if(sec) {
            await apiFetch('/api/update-clip', { method: 'POST', body: JSON.stringify({ id, section: sec }) });
            loadLibrary();
        }
    }

    async function generateSessionSummary() {
        const res = await apiFetch('/api/session-summary', { method: 'POST', body: JSON.stringify({ sessionId: currentSessionId }) });
        const data = await res.json();
        addMessage(data.report, 'model');
    }

    function closeModals() {
        document.querySelectorAll('.modal').forEach(el => { if(el.id !== 'auth-modal') el.style.display = 'none'; });
        document.getElementById('main-player').pause();
    }
</script>
</body>
</html>
