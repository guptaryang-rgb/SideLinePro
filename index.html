<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sideline Pro | Analytics Suite</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050a05; 
            --panel: #0a140a; 
            --border: #142914; 
            --accent: #009933; /* Turf Green */
            --accent-glow: #00cc44;
            --text: #e0e0e0; 
            --muted: #668866;
        }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; display: flex; overflow: hidden; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #222; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .app-container { display: flex; width: 100%; height: 100%; }
        
        /* SIDEBAR */
        .sidebar { width: 260px; background: #020502; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        .sidebar-header { padding: 25px; font-family: 'JetBrains Mono'; color: var(--accent-glow); font-weight: 800; font-size: 1.2rem; letter-spacing: -1px; display: flex; align-items: center; gap: 10px; }
        
        .btn-new { background: var(--accent); color: #000; border: none; padding: 12px; margin: 0 15px 10px; border-radius: 6px; font-weight: 800; cursor: pointer; transition: 0.2s; text-transform: uppercase; font-size: 0.8rem; }
        .btn-new:hover { background: var(--accent-glow); box-shadow: 0 0 15px rgba(0, 153, 51, 0.4); }
        
        .session-list { flex: 1; overflow-y: auto; padding: 10px 15px; }
        .session-item { padding: 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: #88a; font-size: 0.9rem; transition: 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .session-item:hover { background: #0f1f0f; color: white; }
        .session-item.active { background: #0f1f0f; color: var(--accent); border-left: 2px solid var(--accent); }
        .edit-icon { opacity: 0; font-size: 0.8rem; }
        .session-item:hover .edit-icon { opacity: 1; }

        .credits-panel { padding: 20px; border-top: 1px solid var(--border); background: #020502; }
        .buy-btn { width: 100%; background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; margin-top: 8px; font-weight: bold; }
        .buy-btn:hover { background: var(--accent); color: black; }

        /* CHAT SECTION */
        .chat-section { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .header-top { padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #0a140a; }
        .session-title { font-weight: 800; font-size: 1.1rem; color: white; }
        
        #chat-window { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 25px; }
        
        /* MESSAGES */
        .message { padding: 20px; border-radius: 8px; font-size: 0.95rem; line-height: 1.6; max-width: 800px; animation: fadeIn 0.3s; }
        .user-msg { align-self: flex-end; background: #1a2e1a; color: white; border-right: 3px solid var(--accent); }
        .ai-msg { align-self: flex-start; color: #ccc; width: 100%; border-left: 3px solid #333; padding-left: 25px; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARD STYLING */
        .scout-card { background: #0e1c0e; border: 1px solid #1a331a; border-radius: 8px; padding: 20px; margin-top: 10px; }
        .scout-header { display: flex; justify-content: space-between; border-bottom: 1px solid #1a331a; padding-bottom: 10px; margin-bottom: 15px; }
        .scout-title { font-weight: 800; color: var(--accent); font-size: 1.1rem; text-transform: uppercase; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .stat-box { background: #050a05; padding: 10px; border-radius: 4px; }
        .stat-label { font-size: 0.7rem; color: #668866; text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { color: white; font-weight: 600; font-size: 0.9rem; margin-top: 4px; }
        
        .highlight-red { color: #ff5555; font-weight: bold; }
        .highlight-green { color: var(--accent); font-weight: bold; }
        
        /* ACTIONS */
        .action-row { display: flex; gap: 10px; margin-top: 15px; }
        .action-btn { flex: 1; background: #1a331a; border: 1px solid var(--accent); color: var(--accent); padding: 8px; border-radius: 4px; cursor: pointer; font-size: 0.75rem; font-weight: bold; text-align: center; text-decoration: none; }
        .action-btn:hover { background: var(--accent); color: black; }

        /* INPUT AREA */
        .input-area { padding: 25px; border-top: 1px solid var(--border); background: #0a140a; display: flex; gap: 15px; align-items: center; }
        input[type="text"] { background: #050a05; border: 1px solid #1a2e1a; color: white; padding: 15px; border-radius: 6px; flex: 1; outline: none; font-family: 'Inter'; font-size: 1rem; transition: 0.2s; }
        input[type="text"]:focus { border-color: var(--accent); }
        .file-btn { background: #1a2e1a; color: #88a; width: 50px; height: 50px; border-radius: 6px; border: 1px solid #1a331a; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .send-btn { background: var(--accent); color: black; border: none; padding: 0 30px; font-weight: 800; cursor: pointer; height: 50px; border-radius: 6px; }
        
        /* PROGRESS BAR */
        .progress-container { width: 100%; background: #111; height: 4px; border-radius: 2px; margin-top: 10px; display: none; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; animation: load 2s infinite; }
        @keyframes load { 0% { width: 0%; transform: translateX(-100%); } 100% { width: 100%; transform: translateX(100%); } }

        /* LIBRARY SIDEBAR */
        .library-section { width: 320px; background: #0a140a; border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .lib-header { padding: 20px; font-weight: 800; color: #668866; border-bottom: 1px solid var(--border); font-size: 0.8rem; letter-spacing: 1px; }
        .play-card { background: #050a05; border: 1px solid #1a2e1a; padding: 15px; margin: 15px; border-radius: 6px; transition: 0.2s; }
        .play-card:hover { border-color: var(--accent); transform: translateX(-2px); }
        
        /* AUTH MODAL */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .modal-box { background: #0a140a; padding: 40px; border: 1px solid #1a2e1a; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .auth-input { width: 100%; padding: 15px; margin: 10px 0; background: #020502; border: 1px solid #1a2e1a; color: white; border-radius: 4px; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header"><span>‚ö°</span> SIDELINE PRO</div>
        <button class="btn-new" onclick="createNewChat()">+ New Session</button>
        <div id="session-list" class="session-list"></div>
        
        <div class="credits-panel">
            <div style="display:flex; justify-content:space-between; color:#888; font-size:0.8rem;">
                <span>CREDITS</span>
                <span id="credit-display" style="color:white; font-weight:bold;">--</span>
            </div>
            <button class="buy-btn" onclick="buyCredits()">+ 50 Credits ($15)</button>
            <div style="margin-top:10px; font-size:0.7rem; color:#444; cursor:pointer;" onclick="logout()">LOGOUT</div>
        </div>
    </div>

    <div class="chat-section">
        <div class="header-top">
            <span id="current-chat-title" class="session-title">Select a Session</span>
            <button onclick="generateSessionSummary()" style="background:#1a2e1a; border:1px solid #1a331a; color:var(--accent); padding:8px 15px; border-radius:4px; cursor:pointer; font-weight:bold; font-size:0.8rem;">üìÑ CREATE SESSION REPORT</button>
        </div>
        
        <div id="chat-window">
            <div class="message ai-msg">Ready to analyze. Upload a clip to begin.</div>
        </div>
        
        <div class="input-area">
            <input type="file" id="file-input" accept="video/*" style="display:none;">
            <button class="file-btn" onclick="document.getElementById('file-input').click()" id="file-label">üìé</button>
            <input type="text" id="user-input" placeholder="Analyze this play..." autocomplete="off">
            <button class="send-btn" id="send-btn">SEND</button>
        </div>
    </div>

    <div class="library-section">
        <div class="lib-header">SESSION CLIPS</div>
        <div id="library-content" style="flex:1; overflow-y: auto;"></div>
    </div>
</div>

<div id="auth-modal" class="modal">
    <div class="modal-box">
        <div style="color:var(--accent); font-weight:900; font-size:1.5rem; margin-bottom:20px;">SIDELINE PRO</div>
        <input type="email" id="auth-email" class="auth-input" placeholder="Email">
        <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
        <button class="btn-new" style="width:100%; margin:0;" onclick="handleAuth('login')">LOGIN</button>
        <button class="buy-btn" style="border:none; margin-top:10px;" onclick="handleAuth('signup')">Create Account (Get 3 Free Credits)</button>
    </div>
</div>

<script>
    let currentUser = localStorage.getItem('sideline_user');
    let currentSessionId = null;

    window.onload = () => {
        if (!currentUser) document.getElementById('auth-modal').style.display = 'flex';
        else { loadSessions(); loadLibrary(); refreshCredits(); }
    };

    // --- AUTHENTICATION ---
    async function handleAuth(type) {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-pass').value;
        const res = await fetch(`/api/${type}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if (data.success) {
            currentUser = email;
            localStorage.setItem('sideline_user', email);
            document.getElementById('auth-modal').style.display = 'none';
            loadSessions(); loadLibrary(); refreshCredits();
        } else alert(data.error);
    }

    function logout() { localStorage.removeItem('sideline_user'); location.reload(); }

    async function refreshCredits() {
        const res = await fetch('/api/balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser })
        });
        const data = await res.json();
        document.getElementById('credit-display').textContent = data.credits;
    }

    // --- PAYMENTS ---
    async function buyCredits() {
        const res = await fetch('/api/buy-credits', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser })
        });
        const data = await res.json();
        if(data.success) {
            if(data.url) window.location.href = data.url; // Real Stripe
            else { alert(data.message); refreshCredits(); } // Demo Mode
        }
    }

    // --- SESSIONS ---
    async function loadSessions() {
        const res = await fetch(`/api/sessions?email=${currentUser}`);
        const sessions = await res.json();
        const list = document.getElementById('session-list');
        list.innerHTML = '';
        sessions.forEach(s => {
            const div = document.createElement('div');
            div.className = `session-item ${s.id === currentSessionId ? 'active' : ''}`;
            div.innerHTML = `
                <span onclick="loadChat('${s.id}', '${s.title}')" style="flex:1">${s.title}</span>
                <span class="edit-icon" onclick="renameSession('${s.id}')">‚úèÔ∏è</span>
            `;
            list.appendChild(div);
        });
    }

    async function createNewChat() {
        currentSessionId = Math.random().toString(36).substr(2, 9);
        document.getElementById('current-chat-title').textContent = "New Session";
        document.getElementById('chat-window').innerHTML = '<div class="message ai-msg">Session started.</div>';
        document.getElementById('library-content').innerHTML = '';
        loadSessions();
    }

    async function loadChat(id, title) {
        currentSessionId = id;
        document.getElementById('current-chat-title').textContent = title;
        loadSessions();
        const res = await fetch(`/api/session/${id}`);
        const history = await res.json();
        const win = document.getElementById('chat-window');
        win.innerHTML = '';
        history.forEach(msg => addMessage(msg.text, msg.role));
        loadLibrary();
    }

    async function renameSession(id) {
        const newName = prompt("Enter new name:");
        if(newName) {
            await fetch('/api/rename-session', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ sessionId: id, newTitle: newName, email: currentUser })
            });
            loadSessions();
        }
    }

    // --- MESSAGING ---
    document.getElementById('send-btn').addEventListener('click', async () => {
        const text = document.getElementById('user-input').value;
        const file = document.getElementById('file-input').files[0];
        if(!text && !file) return;
        if(!currentSessionId) createNewChat();

        addMessage(text || "Analyzing video clip...", 'user');
        document.getElementById('user-input').value = '';
        
        // Progress Bar
        const win = document.getElementById('chat-window');
        const progressDiv = document.createElement('div');
        progressDiv.innerHTML = `<div class="progress-container" style="display:block"><div class="progress-fill"></div></div>`;
        win.appendChild(progressDiv);
        win.scrollTop = win.scrollHeight;

        const payload = { message: text, sessionId: currentSessionId, email: currentUser };
        if (file) {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                payload.fileData = reader.result.split(',')[1];
                payload.mimeType = file.type;
                sendPayload(payload, progressDiv);
            };
        } else { sendPayload(payload, progressDiv); }
    });

    async function sendPayload(payload, progressDiv) {
        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            progressDiv.remove(); // Remove progress bar
            
            if(data.error) addMessage("Error: " + data.error, 'model');
            else {
                addMessage(data.reply, 'model');
                if(data.newClip) loadLibrary();
                refreshCredits();
            }
        } catch(e) { progressDiv.remove(); addMessage("Connection failed.", 'model'); }
    }

    function addMessage(text, role) {
        const div = document.createElement('div');
        div.className = `message ${role === 'user' ? 'user-msg' : 'ai-msg'}`;
        
        if (role === 'model') {
            try {
                // Check if response is JSON (Analysis)
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                if (firstBrace !== -1 && lastBrace !== -1) {
                    const jsonString = text.substring(firstBrace, lastBrace + 1);
                    const data = JSON.parse(jsonString);
                    div.innerHTML = renderScoutCard(data);
                } else {
                    div.textContent = text;
                }
            } catch(e) { div.textContent = text; }
        } else {
            div.textContent = text;
        }
        
        const win = document.getElementById('chat-window');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    function renderScoutCard(data) {
        // Highlight logic
        const report = data.scouting_report || {};
        return `
            <div class="scout-card">
                <div class="scout-header">
                    <div class="scout-title">${data.title}</div>
                    <div style="font-size:0.7rem; color:#666;">${data.data?.play_type || 'PLAY'}</div>
                </div>
                <div class="stat-grid">
                    <div class="stat-box"><div class="stat-label">FORMATION</div><div class="stat-val">${data.data?.formation}</div></div>
                    <div class="stat-box"><div class="stat-label">COVERAGE</div><div class="stat-val">${data.data?.coverage}</div></div>
                </div>
                <div style="margin-bottom:15px; color:#ccc;">${report.summary}</div>
                
                <div style="margin-bottom:15px;">
                    <div class="stat-label highlight-red">MISTAKES DETECTED</div>
                    <ul style="margin:5px 0; padding-left:20px; color:#ddd;">
                        ${(report.mistakes || []).map(m => `<li>${m}</li>`).join('')}
                    </ul>
                </div>

                <div style="margin-bottom:15px;">
                    <div class="stat-label highlight-green">ACTION PLAN</div>
                    <div style="color:white; margin-top:5px;">${report.action_plan}</div>
                </div>

                <div class="action-row">
                    <a href="#" class="action-btn">WATCH CLIP</a>
                    <div class="action-btn">EXTEND REPORT</div>
                </div>
            </div>
        `;
    }

    // --- LIBRARY ---
    async function loadLibrary() {
        const res = await fetch(`/api/search?email=${currentUser}&sessionId=${currentSessionId}`);
        const clips = await res.json();
        const lib = document.getElementById('library-content');
        lib.innerHTML = '';
        clips.forEach(c => {
            const div = document.createElement('div');
            div.className = 'play-card';
            div.innerHTML = `
                <div style="font-weight:bold; color:#fff; font-size:0.9rem;">${c.title}</div>
                <div style="font-size:0.7rem; color:#668866; margin-top:5px;">${c.formation} vs ${c.coverage}</div>
            `;
            lib.appendChild(div);
        });
    }

    // --- SESSION REPORT ---
    async function generateSessionSummary() {
        if(!currentSessionId) return alert("Select a session first.");
        addMessage("Generating full session report...", 'user');
        const res = await fetch('/api/session-summary', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email: currentUser, sessionId: currentSessionId })
        });
        const data = await res.json();
        addMessage(data.report, 'model');
    }
</script>
</body>
</html>
